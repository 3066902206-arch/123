// Translations
const translations = {
    'zh-CN': {
        settingsTitle: '设置',
        back: '返回',
        icloudInfo: 'Apple ID, iCloud, 媒体与购买项目',
        apiConfig: 'API 配置',
        appearance: '外观设置',
        fullscreen: '全屏模式',
        darkMode: '夜间模式',
        language: '语言',
        returnHome: '返回桌面',
        apiAddress: 'API 地址',
        apiKey: 'API 密钥',
        configureBtn: '配置 (拉取模型)',
        wallpaperTitle: '主屏幕壁纸',
        changeWallpaper: '点击更换壁纸',
        appIconsTitle: '应用图标',
        appName_phone: '电话',
        appName_message: '短信',
        appName_settings: '设置',
        appName_alipay: '支付宝',
        appName_bottle: '漂流瓶',
        appName_taobao: '桃宝',
        appName_redbook: '小红薯',
        saveBtn: '保存配置',
        presetsTitle: '预设',
        selectPreset: '加载预设',
        savePreset: '保存预设',
        fontSettings: '字体',
        fontSize: '字体大小',
        quickActions: '快捷操作',
        reduceTwoSizes: '缩小两号',
        resetFont: '重置默认',
        appearancePresets: '外观预设',
        selectAppearancePreset: '选择预设',
        savePreset: '保存预设',
        resetAppearance: '重置',
        resetToDefault: '重置外观',
        privacy: '隐私与安全'
    },
    'zh-TW': {
        settingsTitle: '設定',
        back: '返回',
        icloudInfo: 'Apple ID, iCloud, 媒體與購買項目',
        apiConfig: 'API 設定',
        appearance: '外觀設定',
        fullscreen: '全螢幕模式',
        darkMode: '深色模式',
        language: '語言',
        returnHome: '返回主畫面',
        apiAddress: 'API 地址',
        apiKey: 'API 金鑰',
        configureBtn: '配置 (拉取模型)',
        wallpaperTitle: '主畫面背景圖片',
        changeWallpaper: '點擊更換背景圖片',
        appIconsTitle: 'App 圖示',
        appName_phone: '電話',
        appName_message: '訊息',
        appName_settings: '設定',
        appName_alipay: '支付寶',
        appName_bottle: '漂流瓶',
        appName_taobao: '淘寶',
        appName_redbook: '小紅書',
        saveBtn: '儲存設定',
        presetsTitle: '預設',
        selectPreset: '載入預設',
        savePreset: '儲存預設',
        fontSettings: '字體',
        fontSize: '字體大小',
        quickActions: '快速操作',
        reduceTwoSizes: '縮小兩號',
        resetFont: '重設預設',
        appearancePresets: '外觀預設',
        selectAppearancePreset: '選擇預設',
        savePreset: '儲存預設',
        resetAppearance: '重設',
        resetToDefault: '重設外觀',
        privacy: '隱私與安全'
    },
    'en': {
        settingsTitle: 'Settings',
        back: 'Back',
        icloudInfo: 'Apple ID, iCloud, Media & Purchases',
        apiConfig: 'API Configuration',
        appearance: 'Appearance',
        fullscreen: 'Full Screen',
        darkMode: 'Dark Mode',
        language: 'Language',
        returnHome: 'Return to Home',
        apiAddress: 'API Address',
        apiKey: 'API Key',
        configureBtn: 'Configure (Fetch Models)',
        wallpaperTitle: 'Home Screen Wallpaper',
        changeWallpaper: 'Tap to Change Wallpaper',
        appIconsTitle: 'App Icons',
        appName_phone: 'Phone',
        appName_message: 'Messages',
        appName_settings: 'Settings',
        appName_alipay: 'Alipay',
        appName_bottle: 'Bottle',
        appName_taobao: 'Taobao',
        appName_redbook: 'Redbook',
        saveBtn: 'Save Configuration',
        presetsTitle: 'Presets',
        selectPreset: 'Load Preset',
        savePreset: 'Save Preset',
        fontSettings: 'Fonts',
        fontSize: 'Font Size',
        quickActions: 'Quick Actions',
        reduceTwoSizes: 'Reduce 2 Sizes',
        resetFont: 'Reset Default',
        appearancePresets: 'Appearance Presets',
        selectAppearancePreset: 'Load Preset',
        savePreset: 'Save Preset',
        resetAppearance: 'Reset',
        resetToDefault: 'Reset Appearance',
        privacy: 'Privacy & Security'
    },
    'ja': {
        settingsTitle: '設定',
        back: '戻る',
        icloudInfo: 'Apple ID、iCloud、メディアと購入',
        apiConfig: 'API構成',
        appearance: '外観モード',
        fullscreen: '全画面',
        darkMode: 'ダークモード',
        language: '言語',
        returnHome: 'ホームに戻る',
        apiAddress: 'APIアドレス',
        apiKey: 'APIキー',
        configureBtn: '構成 (モデル取得)',
        wallpaperTitle: '壁紙',
        changeWallpaper: 'タップして壁紙を変更',
        appIconsTitle: 'アプリアイコン',
        appName_phone: '電話',
        appName_message: 'メッセージ',
        appName_settings: '設定',
        appName_alipay: 'Alipay',
        appName_bottle: 'ボトル',
        appName_taobao: 'タオバオ',
        appName_redbook: '小紅書',
        saveBtn: '設定を保存',
        presetsTitle: 'プリセット',
        selectPreset: 'プリセットを読み込む',
        savePreset: 'プリセットを保存',
        fontSettings: 'フォント',
        fontSize: 'フォントサイズ',
        quickActions: 'クイックアクション',
        reduceTwoSizes: '2サイズ縮小',
        resetFont: 'デフォルトにリセット',
        appearancePresets: '外観プリセット',
        selectAppearancePreset: 'プリセットを選択',
        savePreset: 'プリセットを保存',
        resetAppearance: 'リセット',
        resetToDefault: '外観をリセット',
        privacy: 'プライバシーとセキュリティ'
    },
    'ko': {
        settingsTitle: '설정',
        back: '뒤로',
        icloudInfo: 'Apple ID, iCloud, 미디어 및 구입 항목',
        apiConfig: 'API 구성',
        appearance: '화면 스타일',
        fullscreen: '전체 화면',
        darkMode: '다크 모드',
        language: '언어',
        returnHome: '홈으로 이동',
        apiAddress: 'API 주소',
        apiKey: 'API 키',
        configureBtn: '구성 (모델 가져오기)',
        wallpaperTitle: '배경화면',
        changeWallpaper: '배경화면 변경',
        appIconsTitle: '앱 아이콘',
        appName_phone: '전화',
        appName_message: '메시지',
        appName_settings: '설정',
        appName_alipay: '알리페이',
        appName_bottle: '병 편지',
        appName_taobao: '타오바오',
        appName_redbook: '샤오홍슈',
        saveBtn: '구성 저장',
        presetsTitle: '프리셋',
        selectPreset: '프리셋 로드',
        savePreset: '프리셋 저장',
        fontSettings: '글꼴',
        fontSize: '글꼴 크기',
        quickActions: '빠른 작업',
        reduceTwoSizes: '2단계 축소',
        resetFont: '기본값 재설정',
        appearancePresets: '화면 스타일 프리셋',
        selectAppearancePreset: '프리셋 선택',
        savePreset: '프리셋 저장',
        resetAppearance: '재설정',
        resetToDefault: '화면 스타일 재설정',
        privacy: '개인정보 및 보안'
    }
};

// Default App Configuration
const defaultApps = [
    { id: 'qq', name: 'QQ', iconClass: 'fab fa-qq', color: '#12B7F5', dock: false, action: 'openChatApp' },
    { id: 'oo', name: 'OO', iconClass: 'fas fa-comments', color: '#ffcc00', dock: false, action: 'openChatApp' },
    { id: 'bottle', name: '漂流瓶', nameKey: 'appName_bottle', iconClass: 'fas fa-wine-bottle', color: '#00d2ff', dock: false },
    { id: 'taobao', name: '桃宝', nameKey: 'appName_taobao', iconClass: 'fas fa-shopping-bag', color: '#ff5000', dock: false },
    { id: 'redbook', name: '小红薯', nameKey: 'appName_redbook', iconClass: 'fas fa-book-open', color: '#ff2442', dock: false },
    { id: 'presets', name: '预设', iconClass: 'fas fa-sliders-h', color: '#8e8e93', dock: false },
    { id: 'worldbook', name: '世界书', iconClass: 'fas fa-globe', color: '#007aff', dock: false, action: 'openWorldbook' },
    { id: 'checkpost', name: '查岗', iconClass: 'fas fa-search-location', color: '#ff9500', dock: false },
    { id: 'pinpin', name: '拼拼', iconClass: 'fas fa-puzzle-piece', color: '#5856d6', dock: false },
    { id: 'phone', name: '电话', nameKey: 'appName_phone', iconClass: 'fas fa-phone-alt', color: '#34C759', dock: true },
    { id: 'message', name: '短信', nameKey: 'appName_message', iconClass: 'fas fa-comment', color: '#34C759', dock: true },
    { id: 'alipay', name: '支付宝', nameKey: 'appName_alipay', iconClass: 'fab fa-alipay', color: '#1678ff', dock: true },
    { id: 'settings', name: '设置', nameKey: 'appName_settings', iconClass: 'fas fa-cog', color: '#555', dock: true, action: 'openSettings' }
];

// State Management
let appState = {
    userName: 'iPhone 用户',
    userAvatar: 'https://via.placeholder.com/150',
    wallpaper: '',
    apps: JSON.parse(JSON.stringify(defaultApps)), // Deep copy
    apiConfig: {
        url: '',
        key: '',
        model: ''
    },
    secondaryApiConfig: {
        url: '',
        key: '',
        model: ''
    },
    presets: [],
    appearancePresets: [],
    worldbook: [],
    cardQQ: {
        bg: '',
        avatar: 'https://via.placeholder.com/150',
        name: 'linnnn',
        sign: 'xxxxxxxx',
        id: Math.floor(Math.random() * 900000000) + 100000000,
        visitors: '0',
        tags: ['添加标签'],
        polaroids: [
            'https://via.placeholder.com/100',
            'https://via.placeholder.com/100',
            'https://via.placeholder.com/100',
            'https://via.placeholder.com/100'
        ]
    },
    cardOO: {
        bg: '',
        avatar: 'https://via.placeholder.com/150',
        name: 'linnnn',
        sign: 'xxxxxxxx',
        id: Math.floor(Math.random() * 900000000) + 100000000,
        visitors: '0',
        tags: ['添加标签'],
        polaroids: [
            'https://via.placeholder.com/100',
            'https://via.placeholder.com/100',
            'https://via.placeholder.com/100',
            'https://via.placeholder.com/100'
        ]
    },
    card: { // Fallback/Legacy
        bg: '',
        avatar: 'https://via.placeholder.com/150',
        name: 'linnnn',
        sign: 'xxxxxxxx'
    },
    polaroidImage: 'https://images.unsplash.com/photo-1529626455594-4ff0802cfb7e?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=60',
    daysMatter: {
        bg: '',
        title: '和xxx在一起',
        days: '100天'
    },
    imageWidget: '',
    music: {
        cover: 'https://via.placeholder.com/150',
        title: '歌名',
        artist: '歌手'
    },
    profilePolaroids: [
        'https://via.placeholder.com/100',
        'https://via.placeholder.com/100',
        'https://via.placeholder.com/100',
        'https://via.placeholder.com/100'
    ],
    settingsSign: 'Apple ID, iCloud, 媒体与购买项目',
    fullscreen: false,
    darkMode: false,
    language: 'zh-CN',
    fontOffset: 0,
    theme: 'bunny', // Default to bunny theme as requested
    activeChatApp: 'qq', // Default active chat app
    slotA: { contacts: [], chats: [], posts: [] },
    slotB: { contacts: [], chats: [], posts: [] },
    couplePosts: [],
    personas: [], // Shared persona presets
    globalChatWallpaper: '' // Global chat wallpaper
};

// DOM Elements
const elements = {
    screen: document.getElementById('screen'),
    homeScreen: document.getElementById('homeScreen'),
    rightAppsGrid: document.getElementById('rightAppsGrid'),
    page2Grid: document.getElementById('page2Grid'),
    dock: document.getElementById('dock'),
    settingsApp: document.getElementById('settingsApp'),
    settingsMain: document.getElementById('settingsMain'),
    settingsBackBtn: document.getElementById('settingsBackBtn'),
    settingsTitle: document.getElementById('settingsTitle'),
    pages: {
        apiConfig: document.getElementById('apiConfigPage'),
        appearance: document.getElementById('appearancePage'),
        language: document.getElementById('languagePage'),
        font: document.getElementById('fontPage')
    },
    inputs: {
        avatar: document.getElementById('avatarInput'),
        wallpaper: document.getElementById('wallpaperInput'),
        appIcon: document.getElementById('appIconInput'),
        userName: document.getElementById('userNameInput'),
        apiAddress: document.getElementById('apiAddress'),
        apiKey: document.getElementById('apiKey'),
        secondaryApiAddress: document.getElementById('secondaryApiAddress'),
        secondaryApiKey: document.getElementById('secondaryApiKey'),
        presetName: document.getElementById('presetNameInput'),
        fullScreen: document.getElementById('fullScreenToggle'),
        darkMode: document.getElementById('darkModeToggle'),
        cardBg: document.getElementById('cardBgInput'),
        cardAvatar: document.getElementById('cardAvatarInput'),
        polaroid: document.getElementById('polaroidInput'),
        dmBg: document.getElementById('dmBgInput'),
        imageWidget: document.getElementById('imageWidgetInput'),
        musicCover: document.getElementById('musicCoverInput'),
        fontSlider: document.getElementById('fontSlider'),
        appearancePresetName: document.getElementById('appearancePresetNameInput'),
        chatWallpaper: document.getElementById('chatWallpaperInput'),
        globalChatWallpaper: document.getElementById('globalChatWallpaperInput')
    },
    display: {
        userAvatar: document.getElementById('userAvatar'),
        clock: document.getElementById('clock'),
        wallpaperPreview: document.getElementById('wallpaperPreview'),
        appIconsList: document.getElementById('appIconsList'),
        modelSelect: document.getElementById('modelSelect'),
        currentModel: document.getElementById('currentModelDisplay'),
        modelGroup: document.getElementById('modelSelectionGroup'),
        secondaryModelSelect: document.getElementById('secondaryModelSelect'),
        secondaryCurrentModel: document.getElementById('secondaryCurrentModelDisplay'),
        secondaryModelGroup: document.getElementById('secondaryModelSelectionGroup'),
        presetSelect: document.getElementById('presetSelect'),
        appearancePresetSelect: document.getElementById('appearancePresetSelect'),
        cardBg: document.getElementById('cardBgDisplay'),
        cardAvatarImg: document.getElementById('cardAvatarImg'),
        cardName: document.getElementById('cardName'),
        cardSign: document.getElementById('cardSign'),
        settingsSign: document.getElementById('settingsSign'),
        polaroidImg: document.querySelector('.polaroid img'),
        dmContent: document.querySelector('.dm-content'),
        dmTitle: document.querySelector('.dm-title'),
        dmDays: document.querySelector('.dm-days'),
        imageWidget: document.getElementById('imageWidgetDisplay'),
        musicCover: document.getElementById('musicCoverDisplay'),
        musicTitle: document.getElementById('musicTitleDisplay'),
        musicArtist: document.getElementById('musicArtistDisplay'),
        page2AppsGroup1: document.getElementById('page2AppsGroup1'),
        page2AppsGroup2: document.getElementById('page2AppsGroup2')
    },
    buttons: {
        fetchModels: document.getElementById('fetchModelsBtn'),
        saveApi: document.getElementById('saveApiBtn'),
        fetchSecondaryModels: document.getElementById('fetchSecondaryModelsBtn'),
        saveSecondaryApi: document.getElementById('saveSecondaryApiBtn'),
        savePreset: document.getElementById('savePresetBtn'),
        saveAppearancePreset: document.getElementById('saveAppearancePresetBtn'),
        resetAppearance: document.getElementById('resetAppearanceBtn'),
        settingsHome: document.getElementById('settingsHomeBtn')
    }
};

let currentEditingAppId = null;

// Modal Functions
window.showModal = function(message, isConfirm = false) {
    return new Promise((resolve) => {
        document.getElementById('modalMessage').innerText = message;
        const footer = document.querySelector('#customModal .modal-footer');
        footer.innerHTML = '';
        
        if (isConfirm) {
            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'modal-btn';
            cancelBtn.innerText = '取消';
            cancelBtn.style.color = '#8e8e93';
            cancelBtn.style.borderRight = '1px solid var(--separator-color)';
            cancelBtn.onclick = () => {
                closeModal();
                resolve(false);
            };
            
            const okBtn = document.createElement('button');
            okBtn.className = 'modal-btn';
            okBtn.innerText = '确定';
            okBtn.onclick = () => {
                closeModal();
                resolve(true);
            };
            
            footer.appendChild(cancelBtn);
            footer.appendChild(okBtn);
        } else {
            const okBtn = document.createElement('button');
            okBtn.className = 'modal-btn';
            okBtn.innerText = '确定';
            okBtn.onclick = () => {
                closeModal();
                resolve(true);
            };
            footer.appendChild(okBtn);
        }
        
        document.getElementById('customModal').style.display = 'flex';
    });
}

window.closeModal = function() {
    document.getElementById('customModal').style.display = 'none';
}

window.showTextareaModal = function(message, defaultValue = '') {
    return new Promise((resolve) => {
        const body = document.getElementById('modalMessage');
        body.innerHTML = ''; 
        
        const label = document.createElement('div');
        label.innerText = message;
        label.style.marginBottom = '10px';
        
        const textarea = document.createElement('textarea');
        textarea.value = defaultValue;
        textarea.style.width = '100%';
        textarea.style.height = '100px';
        textarea.style.padding = '8px';
        textarea.style.borderRadius = '8px';
        textarea.style.border = '1px solid #ccc';
        textarea.style.boxSizing = 'border-box';
        textarea.className = 'wb-textarea';
        textarea.style.background = 'rgba(0,0,0,0.05)';
        textarea.onclick = (e) => e.stopPropagation();
        
        body.appendChild(label);
        body.appendChild(textarea);
        
        const footer = document.querySelector('#customModal .modal-footer');
        footer.innerHTML = '';
        
        const cancelBtn = document.createElement('button');
        cancelBtn.className = 'modal-btn';
        cancelBtn.innerText = '取消';
        cancelBtn.style.color = '#8e8e93';
        cancelBtn.style.borderRight = '1px solid var(--separator-color)';
        cancelBtn.onclick = () => {
            closeModal();
            resolve(null);
        };
        
        const okBtn = document.createElement('button');
        okBtn.className = 'modal-btn';
        okBtn.innerText = '确定';
        okBtn.onclick = () => {
            const val = textarea.value;
            closeModal();
            resolve(val);
        };
        
        footer.appendChild(cancelBtn);
        footer.appendChild(okBtn);
        
        document.getElementById('customModal').style.display = 'flex';
        textarea.focus();
    });
}

window.editContactPersona = async function() {
    if (!currentChatContactId) return;
    const slot = (currentChatAppId === 'qq') ? appState.slotA : appState.slotB;
    const contact = slot.contacts.find(c => c.id === currentChatContactId);
    if (!contact) return;

    // Edit Name
    const newName = await showInputModal('修改昵称:', contact.name);
    if (newName !== null) {
        contact.name = newName;
        // Update header immediately
        const headerName = document.getElementById('chatTargetName');
        if (headerName) headerName.innerText = newName;
    }

    // Edit Prompt
    const newPrompt = await showTextareaModal('修改人设 (Prompt):', contact.prompt || '');
    if (newPrompt !== null) {
        contact.prompt = newPrompt;
    }

    if (newName !== null || newPrompt !== null) {
        saveState();
        showModal('修改成功');
    }
};

window.showInputModal = function(message, defaultValue = '') {
    return new Promise((resolve) => {
        const body = document.getElementById('modalMessage');
        body.innerHTML = ''; // Clear text
        
        const label = document.createElement('div');
        label.innerText = message;
        label.style.marginBottom = '10px';
        
        const input = document.createElement('input');
        input.type = 'text';
        input.value = defaultValue;
        input.style.width = '100%';
        input.style.padding = '8px';
        input.style.borderRadius = '8px';
        input.style.border = '1px solid #ccc';
        input.style.boxSizing = 'border-box';
        // Prevent click propagation if inside a clickable container
        input.onclick = (e) => e.stopPropagation();
        
        body.appendChild(label);
        body.appendChild(input);
        
        const footer = document.querySelector('#customModal .modal-footer');
        footer.innerHTML = '';
        
        const cancelBtn = document.createElement('button');
        cancelBtn.className = 'modal-btn';
        cancelBtn.innerText = '取消';
        cancelBtn.style.color = '#8e8e93';
        cancelBtn.style.borderRight = '1px solid var(--separator-color)';
        cancelBtn.onclick = () => {
            closeModal();
            resolve(null);
        };
        
        const okBtn = document.createElement('button');
        okBtn.className = 'modal-btn';
        okBtn.innerText = '确定';
        okBtn.onclick = () => {
            const val = input.value;
            closeModal();
            resolve(val);
        };
        
        footer.appendChild(cancelBtn);
        footer.appendChild(okBtn);
        
        document.getElementById('customModal').style.display = 'flex';
        input.focus();
    });
}

// Initialization
function init() {
    loadState();
    applyTheme(); // Apply theme on startup
    updateLanguageUI();
    renderApps();
    updateUI();
    renderCard();
    setupEventListeners();
    startClock();

    // Load Custom CSS
    const savedCss = localStorage.getItem('customCss');
    if (savedCss) {
        const input = document.getElementById('customCssInput');
        if (input) input.value = savedCss;
        
        let styleTag = document.getElementById('custom-user-css');
        if (!styleTag) {
            styleTag = document.createElement('style');
            styleTag.id = 'custom-user-css';
            document.head.appendChild(styleTag);
        }
        styleTag.textContent = savedCss;
    }
}

// Load State from LocalStorage
function loadState() {
    const savedState = localStorage.getItem('iphoneSimState');
    if (savedState) {
        const parsed = JSON.parse(savedState);
        // Merge saved state with default structure to handle potential schema updates
        appState = { ...appState, ...parsed };
        
        // Ensure app structure integrity (merge saved apps with defaults if needed)
        // simpler approach: if apps exist in saved, use them.
        if (parsed.apps) {
            appState.apps = parsed.apps;
            // Merge new default apps if missing
            defaultApps.forEach(defApp => {
                if (!appState.apps.find(a => a.id === defApp.id)) {
                    appState.apps.push(defApp);
                }
            });
        }
        if (parsed.presets) {
            appState.presets = parsed.presets;
        }
        if (parsed.appearancePresets) {
            appState.appearancePresets = parsed.appearancePresets;
        }
        if (parsed.worldbook) {
            appState.worldbook = parsed.worldbook;
        }
        if (parsed.card) {
            appState.card = { ...appState.card, ...parsed.card };
        }
        if (parsed.settingsSign) {
            appState.settingsSign = parsed.settingsSign;
        }
        if (parsed.polaroidImage) {
            appState.polaroidImage = parsed.polaroidImage;
        }
        if (parsed.daysMatter) {
            appState.daysMatter = { ...appState.daysMatter, ...parsed.daysMatter };
        }
        if (parsed.fontOffset !== undefined) {
            appState.fontOffset = parsed.fontOffset;
        }
        if (parsed.imageWidget) {
            appState.imageWidget = parsed.imageWidget;
        }
        if (parsed.music) {
            appState.music = { ...appState.music, ...parsed.music };
        }
        if (parsed.themePresets) {
            appState.themePresets = parsed.themePresets;
        }
        if (parsed.globalChatWallpaper) {
            appState.globalChatWallpaper = parsed.globalChatWallpaper;
        }

        if (!appState.slotA) appState.slotA = { contacts: [], chats: [] };
        if (!appState.slotB) appState.slotB = { contacts: [], chats: [] };
    }
}

// Save State to LocalStorage
function saveState() {
    // 使用更具体的键名，包含时间戳以避免冲突
    const stateKey = 'iphoneSimState_' + window.location.pathname.replace(/[^a-zA-Z0-9]/g, '_');
    localStorage.setItem(stateKey, JSON.stringify(appState));
    
    // 同时保存一个主键，用于向后兼容
    localStorage.setItem('iphoneSimState', JSON.stringify(appState));
}

// Render Apps on Home Screen and Dock
function renderApps() {
    if (elements.rightAppsGrid) elements.rightAppsGrid.innerHTML = '';
    if (elements.display.page2AppsGroup1) elements.display.page2AppsGroup1.innerHTML = '';
    if (elements.display.page2AppsGroup2) elements.display.page2AppsGroup2.innerHTML = '';
    elements.dock.innerHTML = '';
    elements.display.appIconsList.innerHTML = '';

    const firstPageApps = ['qq', 'oo', 'bottle', 'taobao'];
    const page2Row1Apps = ['presets', 'worldbook', 'checkpost', 'pinpin'];
    const page2Row2Apps = ['redbook'];

    appState.apps.forEach(app => {
        const appEl = createAppElement(app);
        
        if (app.dock) {
            elements.dock.appendChild(appEl);
        } else if (firstPageApps.includes(app.id)) {
            if (elements.rightAppsGrid) elements.rightAppsGrid.appendChild(appEl);
        } else if (page2Row1Apps.includes(app.id)) {
            if (elements.display.page2AppsGroup1) elements.display.page2AppsGroup1.appendChild(appEl);
        } else if (page2Row2Apps.includes(app.id)) {
            if (elements.display.page2AppsGroup2) elements.display.page2AppsGroup2.appendChild(appEl);
        } else {
            // Fallback for any other apps (put in row 1 for now)
            if (elements.display.page2AppsGroup1) elements.display.page2AppsGroup1.appendChild(appEl);
        }

        // Render in Appearance Settings
        const settingsItem = document.createElement('div');
        settingsItem.className = 'app-icon-row';
        settingsItem.onclick = () => initiateAppIconChange(app.id);
        
        let iconStyle = '';
        if (app.customIcon) {
            iconStyle = `background-image: url('${app.customIcon}'); background-color: transparent;`;
        } else {
            iconStyle = `background-color: ${app.color};`;
        }

        const iconContent = app.customIcon ? '' : `<i class="${app.iconClass}"></i>`;

        settingsItem.innerHTML = `
            <div class="mini-icon" style="${iconStyle}">
                ${iconContent}
            </div>
            <span class="item-text">${app.name}</span>
            <i class="fas fa-chevron-right arrow"></i>
        `;
        elements.display.appIconsList.appendChild(settingsItem);
    });
}

function createAppElement(app) {
    const div = document.createElement('div');
    div.className = 'app-item';
    div.onclick = () => handleAppClick(app);

    let iconStyle = '';
    if (app.customIcon) {
        iconStyle = `background-image: url('${app.customIcon}'); background-color: transparent;`;
    } else {
        iconStyle = `background-color: ${app.color};`;
    }

    const iconContent = app.customIcon ? '' : `<i class="${app.iconClass}"></i>`;

    // Determine name based on language
    let displayName = app.name;
    if (app.nameKey) {
        const t = translations[appState.language] || translations['zh-CN'];
        if (t[app.nameKey]) {
            displayName = t[app.nameKey];
        }
    }

    div.innerHTML = `
        <div class="app-icon" style="${iconStyle}">
            ${iconContent}
        </div>
        <div class="app-name">${displayName}</div>
    `;
    return div;
}

// Update UI elements based on state
function updateUI() {
    // Profile
    elements.display.userAvatar.src = appState.userAvatar;
    elements.inputs.userName.value = appState.userName;
    elements.display.settingsSign.innerText = appState.settingsSign;

    // Wallpaper
    if (appState.wallpaper) {
        elements.screen.style.backgroundImage = `url('${appState.wallpaper}')`;
        elements.display.wallpaperPreview.style.backgroundImage = `url('${appState.wallpaper}')`;
        elements.display.wallpaperPreview.innerText = '';
    } else {
        elements.screen.style.backgroundImage = 'none';
        elements.display.wallpaperPreview.style.backgroundImage = 'none';
        elements.display.wallpaperPreview.innerText = '点击更换壁纸';
    }

    // API Config
    elements.inputs.apiAddress.value = appState.apiConfig.url;
    elements.inputs.apiKey.value = appState.apiConfig.key;
    if (appState.apiConfig.model) {
        elements.display.currentModel.innerText = appState.apiConfig.model;
        elements.display.modelGroup.style.display = 'block';
    }

    // Secondary API Config
    elements.inputs.secondaryApiAddress.value = appState.secondaryApiConfig.url;
    elements.inputs.secondaryApiKey.value = appState.secondaryApiConfig.key;
    if (appState.secondaryApiConfig.model) {
        elements.display.secondaryCurrentModel.innerText = appState.secondaryApiConfig.model;
        elements.display.secondaryModelGroup.style.display = 'block';
    }

    // Fullscreen
    elements.inputs.fullScreen.checked = appState.fullscreen;
    if (appState.fullscreen) {
        document.body.classList.add('fullscreen-mode');
    } else {
        document.body.classList.remove('fullscreen-mode');
    }

    // Dark Mode
    elements.inputs.darkMode.checked = appState.darkMode;
    if (appState.darkMode) {
        document.body.classList.add('dark-mode');
    } else {
        document.body.classList.remove('dark-mode');
    }

    // Language Checkmarks
    document.querySelectorAll('.check-icon').forEach(el => el.style.display = 'none');
    const langCheck = document.getElementById(`lang-${appState.language}`);
    if (langCheck) langCheck.style.display = 'block';

    // Polaroid
    if (elements.display.polaroidImg && appState.polaroidImage) {
        elements.display.polaroidImg.src = appState.polaroidImage;
    }

    // Days Matter Widget
    if (elements.display.dmContent) {
        if (appState.daysMatter.bg) {
            elements.display.dmContent.style.backgroundImage = `url('${appState.daysMatter.bg}')`;
        } else {
            elements.display.dmContent.style.backgroundImage = 'none';
        }
    }
    if (elements.display.dmTitle) elements.display.dmTitle.innerText = appState.daysMatter.title;
    if (elements.display.dmDays) elements.display.dmDays.innerText = appState.daysMatter.days;

    // Image Widget
    if (elements.display.imageWidget) {
        if (appState.imageWidget) {
            elements.display.imageWidget.style.backgroundImage = `url('${appState.imageWidget}')`;
        } else {
            elements.display.imageWidget.style.backgroundImage = 'none';
            elements.display.imageWidget.style.backgroundColor = '#ccc';
        }
    }

    // Music Widget
    if (elements.display.musicCover) {
        elements.display.musicCover.src = appState.music?.cover || 'https://via.placeholder.com/150';
    }
    if (elements.display.musicTitle) elements.display.musicTitle.innerText = appState.music?.title || '歌名';
    if (elements.display.musicArtist) elements.display.musicArtist.innerText = appState.music?.artist || '歌手';

    // Font
    document.documentElement.style.setProperty('--font-offset', `${appState.fontOffset}px`);
    if (elements.inputs.fontSlider) {
        elements.inputs.fontSlider.value = appState.fontOffset;
    }

    // Global Chat Wallpaper Preview
    const globalChatWallpaperPreview = document.getElementById('globalChatWallpaperPreview');
    if (globalChatWallpaperPreview) {
        if (appState.globalChatWallpaper) {
            globalChatWallpaperPreview.style.backgroundImage = `url('${appState.globalChatWallpaper}')`;
            globalChatWallpaperPreview.style.backgroundSize = 'cover';
            globalChatWallpaperPreview.style.backgroundPosition = 'center';
            globalChatWallpaperPreview.innerText = '';
        } else {
            globalChatWallpaperPreview.style.backgroundImage = 'none';
            globalChatWallpaperPreview.innerText = '点击更换全局聊天背景';
        }
    }
}

function updateLanguageUI() {
    const lang = appState.language;
    const t = translations[lang] || translations['zh-CN'];
    
    document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (t[key]) {
            el.innerText = t[key];
        }
    });

    // Update app names dynamically
    renderApps();
}

// Update settings sign
if (appState.settingsSign) {
    elements.display.settingsSign.innerText = appState.settingsSign;
}

window.setLanguage = function(lang) {
    appState.language = lang;
    updateLanguageUI();
    updateUI();
    saveState();
};

// Event Listeners
function setupEventListeners() {
    // Navigation
    elements.settingsBackBtn.onclick = goBackSettings;

    // Inputs
    elements.inputs.userName.oninput = (e) => {
        appState.userName = e.target.value;
        saveState();
    };

    elements.inputs.avatar.onchange = (e) => handleImageUpload(e, (result) => {
        appState.userAvatar = result;
        updateUI();
        saveState();
    });

    elements.inputs.wallpaper.onchange = (e) => handleImageUpload(e, (result) => {
        appState.wallpaper = result;
        updateUI();
        saveState();
    });

    elements.inputs.cardBg.onchange = (e) => handleImageUpload(e, (result) => {
        appState.card.bg = result;
        renderCard();
        saveState();
    });

    elements.inputs.cardAvatar.onchange = (e) => handleImageUpload(e, (result) => {
        appState.card.avatar = result;
        renderCard();
        saveState();
    });

    elements.inputs.polaroid.onchange = (e) => handleImageUpload(e, (result) => {
        appState.polaroidImage = result;
        updateUI();
        saveState();
    });

    const polaroidEl = document.querySelector('.polaroid');
    if (polaroidEl) {
        polaroidEl.onclick = () => elements.inputs.polaroid.click();
    }

    // Days Matter Widget Listeners
    elements.inputs.dmBg.onchange = (e) => handleImageUpload(e, (result) => {
        appState.daysMatter.bg = result;
        updateUI();
        saveState();
    });

    const dmContent = document.querySelector('.dm-content');
    if (dmContent) {
        dmContent.onclick = (e) => {
            if (e.target.classList.contains('dm-title') || e.target.classList.contains('dm-days')) return;
            elements.inputs.dmBg.click();
        };
    }

    const dmTitle = document.querySelector('.dm-title');
    if (dmTitle) {
        dmTitle.onclick = async (e) => {
            e.stopPropagation();
            const newTitle = await showInputModal('请输入标题:', appState.daysMatter.title);
            if (newTitle !== null) {
                appState.daysMatter.title = newTitle;
                updateUI();
                saveState();
            }
        };
    }

    const dmDays = document.querySelector('.dm-days');
    if (dmDays) {
        dmDays.onclick = async (e) => {
            e.stopPropagation();
            const newDays = await showInputModal('请输入天数:', appState.daysMatter.days);
            if (newDays !== null) {
                appState.daysMatter.days = newDays;
                updateUI();
                saveState();
            }
        };
    }

    // Image Widget Listener
    elements.inputs.imageWidget.onchange = (e) => handleImageUpload(e, (result) => {
        appState.imageWidget = result;
        updateUI();
        saveState();
    });

    if (elements.display.imageWidget) {
        elements.display.imageWidget.onclick = () => elements.inputs.imageWidget.click();
    }

    // Music Widget Listeners
    if (elements.inputs.musicCover) {
        elements.inputs.musicCover.onchange = (e) => handleImageUpload(e, (result) => {
            if (!appState.music) appState.music = {};
            appState.music.cover = result;
            updateUI();
            saveState();
        });
    }

    if (elements.display.musicTitle) {
        elements.display.musicTitle.onclick = async () => {
            const newTitle = await showInputModal('请输入歌名:', appState.music?.title || '');
            if (newTitle !== null) {
                if (!appState.music) appState.music = {};
                appState.music.title = newTitle;
                updateUI();
                saveState();
            }
        };
    }

    if (elements.display.musicArtist) {
        elements.display.musicArtist.onclick = async () => {
            const newArtist = await showInputModal('请输入歌手:', appState.music?.artist || '');
            if (newArtist !== null) {
                if (!appState.music) appState.music = {};
                appState.music.artist = newArtist;
                updateUI();
                saveState();
            }
        };
    }

    setupSwipe();

    elements.display.cardName.onclick = async () => {
        const newName = await showInputModal('请输入用户名:', appState.card.name);
        if (newName !== null) {
            appState.card.name = newName;
            renderCard();
            saveState();
        }
    };
    
    elements.display.cardSign.onclick = async () => {
        const newSign = await showInputModal('请输入个性签名:', appState.card.sign);
        if (newSign !== null) {
            appState.card.sign = newSign;
            renderCard();
            saveState();
        }
    };

    elements.display.settingsSign.onclick = async () => {
        const newSign = await showInputModal('修改签名:', appState.settingsSign);
        if (newSign !== null) {
            appState.settingsSign = newSign;
            updateUI(); // This will call updateUI -> which updates settingsSign text
            saveState();
        }
    };

    elements.inputs.appIcon.onchange = (e) => handleImageUpload(e, (result) => {
        if (currentEditingAppId) {
            const appIndex = appState.apps.findIndex(a => a.id === currentEditingAppId);
            if (appIndex !== -1) {
                appState.apps[appIndex].customIcon = result;
                renderApps();
                saveState();
            }
        }
    });

    // API
    elements.buttons.fetchModels.onclick = fetchModels;
    elements.buttons.saveApi.onclick = saveApiConfig;
    elements.buttons.fetchSecondaryModels.onclick = fetchSecondaryModels;
    elements.buttons.saveSecondaryApi.onclick = saveSecondaryApiConfig;
    elements.buttons.savePreset.onclick = savePreset;
    elements.buttons.saveAppearancePreset.onclick = saveAppearancePreset;
    elements.buttons.resetAppearance.onclick = resetAppearance;

    // Theme Presets
    const saveThemePresetBtn = document.getElementById('saveThemePresetBtn');
    if (saveThemePresetBtn) saveThemePresetBtn.onclick = saveThemePreset;
    const themePresetSelect = document.getElementById('themePresetSelect');
    if (themePresetSelect) themePresetSelect.onclick = (e) => { if(e.target.value) loadThemePreset(e); }; // Changed to onclick/onchange handling
    if (themePresetSelect) themePresetSelect.onchange = loadThemePreset;
    
    elements.display.modelSelect.onchange = (e) => {
        appState.apiConfig.model = e.target.value;
        elements.display.currentModel.innerText = e.target.value;
        saveState();
    };

    elements.display.secondaryModelSelect.onchange = (e) => {
        appState.secondaryApiConfig.model = e.target.value;
        elements.display.secondaryCurrentModel.innerText = e.target.value;
        saveState();
    };
    
    elements.display.presetSelect.onchange = loadPreset;
    elements.display.appearancePresetSelect.onchange = loadAppearancePreset;

    // Chat Wallpapers
    if (elements.inputs.chatWallpaper) {
        elements.inputs.chatWallpaper.onchange = (e) => handleImageUpload(e, (result) => {
            setIndividualChatWallpaper(result);
        });
    }

    if (elements.inputs.globalChatWallpaper) {
        elements.inputs.globalChatWallpaper.onchange = (e) => handleImageUpload(e, (result) => {
            appState.globalChatWallpaper = result;
            updateUI();
            saveState();
            showModal('全局聊天壁纸已更新');
        });
    }

    // Fullscreen
    elements.inputs.fullScreen.onchange = (e) => {
        appState.fullscreen = e.target.checked;
        updateUI();
        saveState();
    };

    // Dark Mode
    elements.inputs.darkMode.onchange = (e) => {
        appState.darkMode = e.target.checked;
        updateUI();
        saveState();
    };

    if (elements.inputs.fontSlider) {
        elements.inputs.fontSlider.oninput = (e) => {
            setFontOffset(parseInt(e.target.value));
        };
    }
}

window.setFontOffset = function(val) {
    appState.fontOffset = val;
    updateUI();
    saveState();
};

// Navigation Logic
function handleAppClick(app) {
    if (app.action === 'openSettings') {
        openApp(elements.settingsApp);
    } else if (app.action === 'openWorldbook') {
        openWorldbook();
    } else {
        // Just bounce animation or mock open
        console.log(`Open ${app.name}`);
        // Here we could implement other app screens if needed
    }
}

function openApp(appElement) {
    elements.homeScreen.classList.remove('active');
    appElement.classList.add('active');
}

function goHome() {
    document.querySelectorAll('.app-screen').forEach(el => el.classList.remove('active'));
    elements.homeScreen.classList.add('active');
    // Reset settings navigation
    resetSettingsNav();
}

function resetSettingsNav() {
    elements.settingsMain.style.display = 'block';
    Object.values(elements.pages).forEach(page => page.style.display = 'none');
    elements.settingsBackBtn.style.display = 'none';
    if (elements.buttons.settingsHome) elements.buttons.settingsHome.style.display = 'block';
    
    // Remove sub-page class to restore big title
    document.querySelector('.settings-header-nav').classList.remove('sub-page');

    const t = translations[appState.language] || translations['zh-CN'];
    elements.settingsTitle.innerText = t.settingsTitle;
}

// Settings Navigation
window.openSettingsPage = function(pageName) {
    elements.settingsMain.style.display = 'none';
    elements.settingsBackBtn.style.display = 'block';
    if (elements.buttons.settingsHome) elements.buttons.settingsHome.style.display = 'none';
    
    // Add sub-page class for smaller centered title
    document.querySelector('.settings-header-nav').classList.add('sub-page');
    
    // Hide all pages first
    Object.values(elements.pages).forEach(page => {
        if (page) page.style.display = 'none';
    });
    const themePage = document.getElementById('themePage');
    if (themePage) themePage.style.display = 'none';

    // Show specific page
    const t = translations[appState.language] || translations['zh-CN'];
    
    if (pageName === 'apiConfig') {
        elements.pages.apiConfig.style.display = 'block';
        elements.settingsTitle.innerText = t.apiConfig;
        renderPresets();
    } else if (pageName === 'appearance') {
        elements.pages.appearance.style.display = 'block';
        elements.settingsTitle.innerText = t.appearance;
        renderAppearancePresets();
    } else if (pageName === 'language') {
        elements.pages.language.style.display = 'block';
        elements.settingsTitle.innerText = t.language;
    } else if (pageName === 'font') {
        elements.pages.font.style.display = 'block';
        elements.settingsTitle.innerText = t.fontSettings;
    } else if (pageName === 'theme') {
        const themePage = document.getElementById('themePage');
        if (themePage) {
            themePage.style.display = 'block';
            elements.settingsTitle.innerText = '主题';
            updateThemeCheckmarks();
            renderThemePresets();
        }
    }
};

// Theme Functions
window.setTheme = function(theme) {
    appState.theme = theme;
    applyTheme();
    updateThemeCheckmarks();
    saveState();
    showModal(`已切换到${theme === 'default' ? '默认主题' : '小兔主题'}`);
};

function applyTheme() {
    if (appState.theme === 'bunny') {
        // Apply bunny theme - show rabbit ears on icons
        document.body.classList.add('bunny-theme');
        // Change blue color to light pink
        document.documentElement.style.setProperty('--blue', '#FFB6C1');
    } else {
        // Apply default theme - hide rabbit ears
        document.body.classList.remove('bunny-theme');
        // Restore original blue color
        document.documentElement.style.setProperty('--blue', '#007aff');
    }
}

function updateThemeCheckmarks() {
    // Hide all theme checkmarks
    document.querySelectorAll('#theme-default, #theme-bunny').forEach(el => el.style.display = 'none');
    
    // Show checkmark for current theme
    const currentThemeCheck = document.getElementById(`theme-${appState.theme}`);
    if (currentThemeCheck) {
        currentThemeCheck.style.display = 'block';
    }
}

function goBackSettings() {
    // Hide all sub-pages including theme page
    Object.values(elements.pages).forEach(page => {
        if (page) page.style.display = 'none';
    });
    const themePage = document.getElementById('themePage');
    if (themePage) themePage.style.display = 'none';
    
    // Reset to main settings view
    resetSettingsNav();
}

// Image Upload Handler
function handleImageUpload(event, callback) {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = (e) => callback(e.target.result);
        reader.readAsDataURL(file);
    }
}

// App Icon Change Logic
function initiateAppIconChange(appId) {
    currentEditingAppId = appId;
    elements.inputs.appIcon.click();
}

// API Logic
async function fetchModels() {
    const url = elements.inputs.apiAddress.value;
    const key = elements.inputs.apiKey.value;

    if (!url) {
        await showModal('请输入 API 地址');
        return;
    }

    // Save config
    appState.apiConfig.url = url;
    appState.apiConfig.key = key;
    saveState();

    elements.buttons.fetchModels.innerText = '正在获取...';
    elements.buttons.fetchModels.disabled = true;

    try {
        // 完全使用用户输入的API地址，不做任何自动路径添加
        let endpoint = url.trim();
        // 移除末尾多余的斜杠，但不添加任何路径
        endpoint = endpoint.replace(/\/+$/, '');

        const headers = {};
        if (key) {
            headers['Authorization'] = `Bearer ${key}`;
        }

        const response = await fetch(endpoint, {
            method: 'GET',
            headers: headers
        });

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const data = await response.json();
        
        // Populate Select
        elements.display.modelSelect.innerHTML = '<option value="" disabled selected>选择一个模型</option>';
        
        if (data.data && Array.isArray(data.data)) {
            data.data.forEach(model => {
                const option = document.createElement('option');
                option.value = model.id;
                option.innerText = model.id;
                elements.display.modelSelect.appendChild(option);
            });
            elements.display.modelGroup.style.display = 'block';
            await showModal('模型获取成功，请在下方选择模型。');
        } else {
            throw new Error('无法解析模型数据格式');
        }

    } catch (error) {
        console.error('API Error:', error);
        
        // 显示详细的错误信息
        let errorMessage = 'API拉取失败:\n';
        if (error.name === 'TypeError' && error.message.includes('fetch')) {
            errorMessage += '• 网络连接失败，请检查API地址是否正确\n';
            errorMessage += '• 确保API服务正在运行\n';
            errorMessage += '• 检查是否存在跨域问题';
        } else if (error.message.includes('HTTP 401')) {
            errorMessage += '• API密钥无效或已过期\n';
            errorMessage += '• 请检查API密钥是否正确';
        } else if (error.message.includes('HTTP 403')) {
            errorMessage += '• 访问被拒绝\n';
            errorMessage += '• 请检查API密钥权限';
        } else if (error.message.includes('HTTP 404')) {
            errorMessage += '• API地址不存在\n';
            errorMessage += '• 请检查API地址是否正确';
        } else {
            errorMessage += `• ${error.message}`;
        }
        
        await showModal(errorMessage);
        
        // Fallback for demo purposes if fetch fails (since we don't have a real backend usually)
        if (await showModal('是否加载演示模型数据? (用于测试界面功能)', true)) {
            loadMockModels();
        }
    } finally {
        elements.buttons.fetchModels.innerText = '配置 (拉取模型)';
        elements.buttons.fetchModels.disabled = false;
    }
}

function loadMockModels() {
    const mockModels = ['gpt-3.5-turbo', 'gpt-4', 'claude-3-opus', 'gemini-pro'];
    elements.display.modelSelect.innerHTML = '<option value="" disabled selected>选择一个模型</option>';
    mockModels.forEach(m => {
        const option = document.createElement('option');
        option.value = m;
        option.innerText = m;
        elements.display.modelSelect.appendChild(option);
    });
    elements.display.modelGroup.style.display = 'block';
}

// Secondary API Logic
async function fetchSecondaryModels() {
    const url = elements.inputs.secondaryApiAddress.value;
    const key = elements.inputs.secondaryApiKey.value;

    if (!url) {
        await showModal('请输入副API地址');
        return;
    }

    // Save config
    appState.secondaryApiConfig.url = url;
    appState.secondaryApiConfig.key = key;
    saveState();

    elements.buttons.fetchSecondaryModels.innerText = '正在获取...';
    elements.buttons.fetchSecondaryModels.disabled = true;

    try {
        let endpoint = url.trim();
        endpoint = endpoint.replace(/\/+$/, '');

        const headers = {};
        if (key) {
            headers['Authorization'] = `Bearer ${key}`;
        }

        const response = await fetch(endpoint, {
            method: 'GET',
            headers: headers
        });

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const data = await response.json();
        
        elements.display.secondaryModelSelect.innerHTML = '<option value="" disabled selected>选择一个模型</option>';
        
        if (data.data && Array.isArray(data.data)) {
            data.data.forEach(model => {
                const option = document.createElement('option');
                option.value = model.id;
                option.innerText = model.id;
                elements.display.secondaryModelSelect.appendChild(option);
            });
            elements.display.secondaryModelGroup.style.display = 'block';
            await showModal('副API模型获取成功，请在下方选择模型。');
        } else {
            throw new Error('无法解析模型数据格式');
        }

    } catch (error) {
        console.error('Secondary API Error:', error);
        
        let errorMessage = '副API拉取失败:\n';
        if (error.name === 'TypeError' && error.message.includes('fetch')) {
            errorMessage += '• 网络连接失败，请检查API地址是否正确\n';
            errorMessage += '• 确保API服务正在运行\n';
            errorMessage += '• 检查是否存在跨域问题';
        } else if (error.message.includes('HTTP 401')) {
            errorMessage += '• API密钥无效或已过期\n';
            errorMessage += '• 请检查API密钥是否正确';
        } else if (error.message.includes('HTTP 403')) {
            errorMessage += '• 访问被拒绝\n';
            errorMessage += '• 请检查API密钥权限';
        } else if (error.message.includes('HTTP 404')) {
            errorMessage += '• API地址不存在\n';
            errorMessage += '• 请检查API地址是否正确';
        } else {
            errorMessage += `• ${error.message}`;
        }
        
        await showModal(errorMessage);
        
        if (await showModal('是否加载演示模型数据? (用于测试界面功能)', true)) {
            loadSecondaryMockModels();
        }
    } finally {
        elements.buttons.fetchSecondaryModels.innerText = '配置 (拉取模型)';
        elements.buttons.fetchSecondaryModels.disabled = false;
    }
}

function loadSecondaryMockModels() {
    const mockModels = ['gpt-3.5-turbo', 'gpt-4', 'claude-3-opus', 'gemini-pro'];
    elements.display.secondaryModelSelect.innerHTML = '<option value="" disabled selected>选择一个模型</option>';
    mockModels.forEach(m => {
        const option = document.createElement('option');
        option.value = m;
        option.innerText = m;
        elements.display.secondaryModelSelect.appendChild(option);
    });
    elements.display.secondaryModelGroup.style.display = 'block';
}

function saveSecondaryApiConfig() {
    appState.secondaryApiConfig.url = elements.inputs.secondaryApiAddress.value;
    appState.secondaryApiConfig.key = elements.inputs.secondaryApiKey.value;
    saveState();
    showModal('副API配置保存成功');
}

// Card Logic
function renderCard() {
    if (appState.card.bg) {
        elements.display.cardBg.style.backgroundImage = `url('${appState.card.bg}')`;
        elements.display.cardBg.style.backgroundColor = 'transparent';
    } else {
        elements.display.cardBg.style.backgroundImage = 'none';
        elements.display.cardBg.style.backgroundColor = '#ccc';
    }
    
    if (appState.card.avatar) {
        elements.display.cardAvatarImg.src = appState.card.avatar;
    }
    
    if (appState.card.name) elements.display.cardName.innerText = appState.card.name;
    if (appState.card.sign) elements.display.cardSign.innerText = appState.card.sign;
}

// API Preset Logic
function saveApiConfig() {
    appState.apiConfig.url = elements.inputs.apiAddress.value;
    appState.apiConfig.key = elements.inputs.apiKey.value;
    saveState();
    showModal('保存成功');
}

// Appearance Preset Logic
function renderAppearancePresets() {
    const select = elements.display.appearancePresetSelect;
    select.innerHTML = '<option value="" disabled selected>加载预设...</option>';
    
    if (appState.appearancePresets && appState.appearancePresets.length > 0) {
        appState.appearancePresets.forEach((preset, index) => {
            const option = document.createElement('option');
            option.value = index;
            option.innerText = preset.name;
            select.appendChild(option);
        });
    }
}

function saveAppearancePreset() {
    const name = elements.inputs.appearancePresetName.value.trim();
    if (!name) {
        showModal('请输入预设名称');
        return;
    }

    if (!appState.appearancePresets) {
        appState.appearancePresets = [];
    }

    // Capture current appearance state
    const currentAppearance = {
        name: name,
        wallpaper: appState.wallpaper,
        fontOffset: appState.fontOffset,
        darkMode: appState.darkMode,
        fullscreen: appState.fullscreen,
        // Only save customization of apps (icons, colors)
        appCustomizations: appState.apps.map(app => ({
            id: app.id,
            customIcon: app.customIcon,
            color: app.color
        }))
    };

    appState.appearancePresets.push(currentAppearance);
    saveState();
    renderAppearancePresets();
    elements.inputs.appearancePresetName.value = '';
    showModal('外观预设保存成功');
}

function loadAppearancePreset(e) {
    const index = e.target.value;
    if (appState.appearancePresets && appState.appearancePresets[index]) {
        const preset = appState.appearancePresets[index];
        
        // Restore State
        if (preset.wallpaper !== undefined) appState.wallpaper = preset.wallpaper;
        if (preset.fontOffset !== undefined) appState.fontOffset = preset.fontOffset;
        if (preset.darkMode !== undefined) appState.darkMode = preset.darkMode;
        if (preset.fullscreen !== undefined) appState.fullscreen = preset.fullscreen;
        
        if (preset.appCustomizations) {
            preset.appCustomizations.forEach(customApp => {
                const app = appState.apps.find(a => a.id === customApp.id);
                if (app) {
                    if (customApp.customIcon !== undefined) app.customIcon = customApp.customIcon;
                    if (customApp.color !== undefined) app.color = customApp.color;
                }
            });
        }
        
        // Update UI
        updateUI();
        renderApps();
        saveState();
        showModal(`已加载外观: ${preset.name}`);
        
        // Reset select
        e.target.value = "";
    }
}

function resetAppearance() {
    showModal('确定要重置外观设置为默认吗？', true).then(confirm => {
        if (confirm) {
            // Reset to defaults
            appState.wallpaper = '';
            // appState.fontOffset = 0; // Font size should not be reset
            appState.darkMode = false;
            // appState.fullscreen = false; // Optional: maybe keep fullscreen setting
            
            // Reset App Icons (reload defaults)
            // We need to keep non-appearance state of apps (like dock position if editable, but here only icons are customized)
            // For simplicity, we clear customIcon from current apps
            appState.apps.forEach(app => {
                const def = defaultApps.find(d => d.id === app.id);
                if (def) {
                    app.customIcon = undefined;
                    app.color = def.color;
                    app.iconClass = def.iconClass;
                }
            });

            updateUI();
            renderApps();
            saveState();
            showModal('外观已重置');
        }
    });
}

function renderPresets() {
    const select = elements.display.presetSelect;
    // Keep the placeholder
    select.innerHTML = '<option value="" disabled selected>加载预设...</option>';
    
    if (appState.presets && appState.presets.length > 0) {
        appState.presets.forEach((preset, index) => {
            const option = document.createElement('option');
            option.value = index;
            option.innerText = preset.name;
            select.appendChild(option);
        });
    }
}

function savePreset() {
    const name = elements.inputs.presetName.value.trim();
    if (!name) {
        showModal('请输入预设名称');
        return;
    }
    
    // Ensure presets array exists
    if (!appState.presets) {
        appState.presets = [];
    }
    
    const newPreset = {
        name: name,
        url: elements.inputs.apiAddress.value,
        key: elements.inputs.apiKey.value,
        model: appState.apiConfig.model
    };
    
    appState.presets.push(newPreset);
    saveState();
    renderPresets();
    elements.inputs.presetName.value = ''; // Clear input
    showModal('预设保存成功');
}

function loadPreset(e) {
    const index = e.target.value;
    if (appState.presets && appState.presets[index]) {
        const preset = appState.presets[index];
        
        // Update State
        appState.apiConfig.url = preset.url;
        appState.apiConfig.key = preset.key;
        appState.apiConfig.model = preset.model || '';
        
        // Update UI
        elements.inputs.apiAddress.value = preset.url;
        elements.inputs.apiKey.value = preset.key;
        if (preset.model) {
            elements.display.currentModel.innerText = preset.model;
            // Also try to set the select if options exist
             // Note: Model select options might not be populated if fetch hasn't run.
             // We just show the stored model name.
             elements.display.modelGroup.style.display = 'block';
        }
        
        saveState();
        showModal(`已加载: ${preset.name}`);
        
        // Reset select to placeholder
        e.target.value = "";
    }
}

// Mouse Swipe Logic
function setupSwipe() {
    const slider = document.getElementById('pagesWrapper');
    if (!slider) return;

    let isDown = false;
    let startX;
    let scrollLeft;

    slider.addEventListener('mousedown', (e) => {
        isDown = true;
        slider.style.cursor = 'grabbing';
        slider.style.scrollSnapType = 'none'; // Disable snap while dragging
        startX = e.pageX - slider.offsetLeft;
        scrollLeft = slider.scrollLeft;
        e.preventDefault(); // Prevent text selection
    });

    slider.addEventListener('mouseleave', () => {
        isDown = false;
        slider.style.cursor = 'grab';
        slider.style.scrollSnapType = 'x mandatory'; // Enable snap
    });

    slider.addEventListener('mouseup', () => {
        isDown = false;
        slider.style.cursor = 'grab';
        slider.style.scrollSnapType = 'x mandatory'; // Enable snap
    });

    slider.addEventListener('mousemove', (e) => {
        if (!isDown) return;
        e.preventDefault();
        const x = e.pageX - slider.offsetLeft;
        const walk = (x - startX) * 2; // Scroll speed
        slider.scrollLeft = scrollLeft - walk;
    });
    
    // Set initial cursor
    slider.style.cursor = 'grab';
}

// Worldbook Logic
let currentWbId = null;

window.openWorldbook = function() {
    elements.homeScreen.classList.remove('active');
    document.getElementById('worldbookApp').classList.add('active');
    renderWbList();
    closeWbEditor(); // Ensure list view
};

window.renderWbList = function() {
    const listEl = document.getElementById('wbListContent');
    listEl.innerHTML = '';
    
    if (!appState.worldbook || appState.worldbook.length === 0) {
        listEl.innerHTML = '<div class="settings-header-text" style="text-align: center; margin-top: 50px;">暂无条目，点击右上角添加</div>';
        return;
    }
    
    appState.worldbook.forEach(item => {
        const div = document.createElement('div');
        div.className = 'settings-item';
        div.onclick = () => openWbEditor(item.id);
        
        let icon = 'fa-file-alt';
        let color = '#8e8e93';
        
        if (item.type === 'world') { icon = 'fa-globe'; color = '#007aff'; }
        else if (item.type === 'character') { icon = 'fa-user'; color = '#ff9500'; }
        else if (item.type === 'item') { icon = 'fa-cube'; color = '#34c759'; }
        
        div.innerHTML = `
            <div class="icon-box" style="background-color: ${color};"><i class="fas ${icon}"></i></div>
            <div class="item-text" style="display: flex; flex-direction: column; align-items: flex-start;">
                <span style="font-weight: 500;">${item.title}</span>
                <span style="font-size: 12px; color: var(--sub-text-color);">${item.content.substring(0, 20)}${item.content.length > 20 ? '...' : ''}</span>
            </div>
            <i class="fas fa-chevron-right arrow"></i>
        `;
        listEl.appendChild(div);
    });
};

window.openWbEditor = function(id = null) {
    currentWbId = id;
    document.getElementById('wbListView').style.display = 'none';
    document.getElementById('wbEditorView').style.display = 'flex';
    document.getElementById('wbDeleteGroup').style.display = id ? 'block' : 'none';
    
    if (id) {
        const item = appState.worldbook.find(i => i.id === id);
        if (item) {
            document.getElementById('wbTitleInput').value = item.title;
            document.getElementById('wbTypeInput').value = item.type;
            document.getElementById('wbContentInput').value = item.content;
        }
    } else {
        document.getElementById('wbTitleInput').value = '';
        document.getElementById('wbTypeInput').value = 'world';
        document.getElementById('wbContentInput').value = '';
    }
};

window.closeWbEditor = function() {
    document.getElementById('wbEditorView').style.display = 'none';
    document.getElementById('wbListView').style.display = 'flex';
    currentWbId = null;
};

window.saveWbEntry = function() {
    const title = document.getElementById('wbTitleInput').value.trim();
    const type = document.getElementById('wbTypeInput').value;
    const content = document.getElementById('wbContentInput').value;
    
    if (!title) {
        showModal('请输入标题');
        return;
    }
    
    if (!appState.worldbook) appState.worldbook = [];
    
    if (currentWbId) {
        // Edit
        const index = appState.worldbook.findIndex(i => i.id === currentWbId);
        if (index !== -1) {
            appState.worldbook[index] = { ...appState.worldbook[index], title, type, content, updatedAt: Date.now() };
        }
    } else {
        // New
        const newItem = {
            id: Date.now().toString(),
            title,
            type,
            content,
            createdAt: Date.now(),
            updatedAt: Date.now()
        };
        appState.worldbook.push(newItem);
    }
    
    saveState();
    closeWbEditor();
    renderWbList();
};

window.deleteWbEntry = async function() {
    if (!currentWbId) return;
    
    const confirm = await showModal('确定要删除这个条目吗？', true);
    if (confirm) {
        appState.worldbook = appState.worldbook.filter(i => i.id !== currentWbId);
        saveState();
        closeWbEditor();
        renderWbList();
    }
};

// Clock
function startClock() {
    const updateTime = () => {
        const now = new Date();
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        
        // Status Bar Clock
        if (elements.display.clock) elements.display.clock.innerText = `${hours}:${minutes}`;
    };
    updateTime();
    setInterval(updateTime, 1000); // Update every second to be responsive
}

// Chat App Logic
let currentChatAppId = null; // 'qq' or 'oo'
let currentChatContactId = null;

window.openChatApp = function(appId) {
    if (appId !== 'qq' && appId !== 'oo') return;
    
    currentChatAppId = appId;
    
    // Update UI Title
    document.getElementById('chatAppTitle').innerText = (appId === 'qq') ? 'QQ' : 'OO';
    
    // Switch Screen
    elements.homeScreen.classList.remove('active');
    document.getElementById('chatApp').classList.add('active');
    
    // Reset Views using switchToMessages to ensure clean state
    switchToMessages();
    // Ensure bottom bar is visible
    document.getElementById('bottomNavBar').style.display = 'flex';
    
    renderChatList();
};

window.renderChatList = function() {
    const listEl = document.getElementById('chatListContent');
    listEl.innerHTML = '';
    
    const slot = (currentChatAppId === 'qq') ? appState.slotA : appState.slotB;
    
    if (!slot.contacts || slot.contacts.length === 0) {
        listEl.innerHTML = '<div class="settings-header-text" style="text-align: center; margin-top: 50px;">暂无好友，点击右上角添加</div>';
        return;
    }
    
    slot.contacts.forEach(contact => {
        const div = document.createElement('div');
        div.className = 'settings-item';
        div.onclick = () => openChat(contact.id);
        
        div.innerHTML = `
            <div class="avatar-wrapper" style="width: 40px; height: 40px; margin-right: 12px;">
                <img src="${contact.avatar}" style="border-radius: 50%; width: 100%; height: 100%; object-fit: cover;">
            </div>
            <div class="item-text" style="display: flex; flex-direction: column; align-items: flex-start;">
                <span style="font-weight: 500;">${contact.name}</span>
                <span style="font-size: 12px; color: var(--sub-text-color);">点击开始聊天</span>
            </div>
            <i class="fas fa-chevron-right arrow"></i>
        `;
        listEl.appendChild(div);
    });
};

window.openAddContact = function() {
    document.getElementById('chatListView').style.display = 'none';
    document.getElementById('addContactView').style.display = 'flex';
    
    // Reset Inputs
    document.getElementById('contactNameInput').value = '';
    document.getElementById('contactAvatarPreview').src = 'https://via.placeholder.com/150';
    document.getElementById('contactPromptInput').value = '';
    
    // Populate Worldbook Select
    const select = document.getElementById('contactWorldbookSelect');
    select.innerHTML = '<option value="">无关联</option>';
    if (appState.worldbook && appState.worldbook.length > 0) {
        appState.worldbook.forEach(item => {
            // Only show characters or world settings
            if (item.type === 'character' || item.type === 'world') {
                const option = document.createElement('option');
                option.value = item.id;
                option.innerText = item.title;
                select.appendChild(option);
            }
        });
    }
    
    // Select Change Listener - don't auto-fill anything, let user control all fields
    select.onchange = (e) => {
        const wbId = e.target.value;
        // Don't auto-fill name or prompt - let user have full control
        // World book is only for AI reference, not for overriding user input
    };
};

window.closeAddContact = function() {
    document.getElementById('addContactView').style.display = 'none';
    document.getElementById('chatListView').style.display = 'flex';
};

window.saveContact = function() {
    const name = document.getElementById('contactNameInput').value.trim();
    const displayName = document.getElementById('contactDisplayNameInput').value.trim();
    const remark = document.getElementById('contactRemarkInput').value.trim();
    const avatar = document.getElementById('contactAvatarPreview').src;
    const wbId = document.getElementById('contactWorldbookSelect').value;
    const prompt = document.getElementById('contactPromptInput').value;
    
    if (!name) {
        showModal('请输入昵称');
        return;
    }
    
    const newContact = {
        id: Date.now().toString(),
        name,
        displayName: displayName || null,
        remark: remark || null,
        avatar,
        wbId,
        prompt,
        friends: [], // 朋友档案
        createdAt: Date.now()
    };
    
    const slot = (currentChatAppId === 'qq') ? appState.slotA : appState.slotB;
    if (!slot.contacts) slot.contacts = [];
    slot.contacts.push(newContact);
    
    // 确保数据结构完整
    if (currentChatAppId === 'qq') {
        appState.slotA = slot;
    } else {
        appState.slotB = slot;
    }
    
    saveState();
    closeAddContact();
    renderChatList();
    showModal('联系人添加成功');
};

window.openChat = function(contactId) {
    currentChatContactId = contactId;
    const slot = (currentChatAppId === 'qq') ? appState.slotA : appState.slotB;
    const contact = slot.contacts.find(c => c.id === contactId);
    
    if (!contact) return;
    
    document.getElementById('chatTargetName').innerText = contact.name;
    // Hide list and bottom nav
    document.getElementById('chatListView').style.display = 'none';
    document.getElementById('contactsView').style.display = 'none'; // Ensure contacts view is hidden too if opened from there
    document.getElementById('bottomNavBar').style.display = 'none';
    
    document.getElementById('chatDetailView').style.display = 'flex';
    
    renderMessages();
};

window.closeChat = function() {
    document.getElementById('chatDetailView').style.display = 'none';
    document.getElementById('bottomNavBar').style.display = 'flex';
    
    // Return to previous view context - for simplicity, default to messages list or check logic?
    // User could have opened chat from Contacts list. 
    // Let's check which view was active? Hard to track without extra state.
    // Defaulting to messages list is standard behavior usually, or we can see which button is active.
    
    const contactsBtn = document.querySelector('.bottom-nav-btn[onclick="switchToContacts()"]');
    if (contactsBtn && contactsBtn.classList.contains('active')) {
        document.getElementById('contactsView').style.display = 'flex';
    } else {
        document.getElementById('chatListView').style.display = 'flex';
        // Ensure switch to messages tab visually if we force list view? 
        // If we came from contacts, we want to stay in contacts tab? 
        // If we open chat from contacts, we are technically in a "chat" context now.
        // Let's just restore based on nav bar active state.
    }
    
    currentChatContactId = null;
};

window.openEditPersona = function() {
    if (!currentChatContactId) return;
    document.getElementById('chatDetailView').style.display = 'none';
    // If we are in settings view, hide it too
    document.getElementById('chatSettingsView').style.display = 'none';
    openContactProfile(currentChatContactId);
};

// New Chat Settings Logic
window.openChatSettings = function() {
    document.getElementById('chatDetailView').style.display = 'none';
    document.getElementById('chatSettingsView').style.display = 'flex';
    
    // Update Wallpaper Preview for current contact
    const slot = (currentChatAppId === 'qq') ? appState.slotA : appState.slotB;
    const contact = slot.contacts.find(c => c.id === currentChatContactId);
    const preview = document.getElementById('chatWallpaperPreview');
    
    if (preview) {
        if (contact && contact.wallpaper) {
            preview.style.backgroundImage = `url('${contact.wallpaper}')`;
            preview.innerText = '';
        } else {
            preview.style.backgroundImage = 'none';
            preview.innerText = '点击更换聊天背景';
        }
    }
};

window.closeChatSettings = function() {
    document.getElementById('chatSettingsView').style.display = 'none';
    document.getElementById('chatDetailView').style.display = 'flex';
};

window.setIndividualChatWallpaper = function(imageData) {
    if (!currentChatContactId) return;
    
    const slot = (currentChatAppId === 'qq') ? appState.slotA : appState.slotB;
    const contact = slot.contacts.find(c => c.id === currentChatContactId);
    
    if (contact) {
        contact.wallpaper = imageData;
        saveState();
        
        // Update preview immediately
        const preview = document.getElementById('chatWallpaperPreview');
        if (preview) {
            preview.style.backgroundImage = `url('${imageData}')`;
            preview.innerText = '';
        }
        
        // Also update chat view background if it's visible or will be visible
        const chatArea = document.getElementById('chatMessagesArea');
        if (chatArea) {
            chatArea.style.backgroundImage = `url('${imageData}')`;
        }
    }
};

window.resetGlobalChatWallpaper = function() {
    showModal('确定要清除全局聊天壁纸吗？', true).then(confirm => {
        if (confirm) {
            appState.globalChatWallpaper = '';
            saveState();
            updateUI();
            showModal('全局聊天壁纸已清除');
        }
    });
};

window.clearChatHistory = async function() {
    if (!currentChatContactId) return;
    
    const confirm = await showModal('确定要清空与该联系人的聊天记录吗？', true);
    if (confirm) {
        const slot = (currentChatAppId === 'qq') ? appState.slotA : appState.slotB;
        const chat = slot.chats.find(c => c.contactId === currentChatContactId);
        if (chat) {
            chat.messages = []; // 清空消息
            saveState();
            renderMessages(); // 刷新视图
            showModal('聊天记录已清空');
        }
    }
};

window.editContactPersona = async function() {
    if (!currentChatContactId) return;
    const slot = (currentChatAppId === 'qq') ? appState.slotA : appState.slotB;
    const contact = slot.contacts.find(c => c.id === currentChatContactId);
    if (!contact) return;

    const newPrompt = await showTextareaModal('修改人设 (Prompt):', contact.prompt || '');
    if (newPrompt !== null) {
        contact.prompt = newPrompt;
        saveState();
        showModal('人设修改成功');
    }
};

window.renderMessages = function() {
    const area = document.getElementById('chatMessagesArea');
    area.innerHTML = '';
    
    const slot = (currentChatAppId === 'qq') ? appState.slotA : appState.slotB;
    const contact = slot.contacts.find(c => c.id === currentChatContactId);

    // Apply Wallpaper
    // Priority: Individual > Global > None
    if (contact && contact.wallpaper) {
        area.style.backgroundImage = `url('${contact.wallpaper}')`;
    } else if (appState.globalChatWallpaper) {
        area.style.backgroundImage = `url('${appState.globalChatWallpaper}')`;
    } else {
        area.style.backgroundImage = 'none';
    }

    // Find or init chat history
    let chat = slot.chats.find(c => c.contactId === currentChatContactId);
    if (!chat) {
        chat = { contactId: currentChatContactId, messages: [] };
        slot.chats.push(chat); // Save immediately so we have a ref
        saveState();
    }
    
    // Get Avatars
    let userAvatar = appState.userAvatar;
    if (currentChatAppId === 'qq' && appState.cardQQ && appState.cardQQ.avatar) {
        userAvatar = appState.cardQQ.avatar;
    } else if (currentChatAppId === 'oo' && appState.cardOO && appState.cardOO.avatar) {
        userAvatar = appState.cardOO.avatar;
    }

    const contactAvatar = contact ? contact.avatar : 'https://via.placeholder.com/150';

    chat.messages.forEach(msg => {
        const row = document.createElement('div');
        row.className = `message-row ${msg.role === 'user' ? 'sent' : 'received'}`;
        row.style.cssText = 'display: flex; width: 100%; margin-bottom: 10px; align-items: flex-end; justify-content: ' + (msg.role === 'user' ? 'flex-end' : 'flex-start') + ';';
        
        const avatar = document.createElement('img');
        avatar.className = 'message-avatar';
        avatar.style.cssText = 'width: 32px; height: 32px; border-radius: 50%; margin: 0 10px; flex-shrink: 0; object-fit: cover;';
        avatar.src = msg.role === 'user' ? userAvatar : contactAvatar;

        const bubble = document.createElement('div');
        bubble.className = `chat-bubble ${msg.role === 'user' ? 'sent' : 'received'}`;
        
        const time = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        
        bubble.innerHTML = `
            ${msg.content}
        `;
        
        if (msg.role === 'user') {
            row.appendChild(bubble);
            row.appendChild(avatar);
        } else {
            row.appendChild(avatar);
            row.appendChild(bubble);
        }
        
        area.appendChild(row);
    });
    
    // Scroll to bottom
    area.scrollTop = area.scrollHeight;
};

window.sendChatMessage = function() {
    const input = document.getElementById('chatInput');
    const text = input.value.trim();
    if (!text || !currentChatContactId) return;
    
    input.value = '';
    
    const slot = (currentChatAppId === 'qq') ? appState.slotA : appState.slotB;
    let chat = slot.chats.find(c => c.contactId === currentChatContactId);
    if (!chat) {
        chat = { contactId: currentChatContactId, messages: [] };
        slot.chats.push(chat);
    }
    
    // User Message
    chat.messages.push({
        role: 'user',
        content: text,
        timestamp: Date.now()
    });
    
    saveState();
    renderMessages();
};

window.triggerAIReply = async function() {
    if (!currentChatContactId) return;
    
    const slot = (currentChatAppId === 'qq') ? appState.slotA : appState.slotB;
    let chat = slot.chats.find(c => c.contactId === currentChatContactId);
    if (!chat) {
        chat = { contactId: currentChatContactId, messages: [] };
        slot.chats.push(chat);
    }
    
    const contact = slot.contacts.find(c => c.id === currentChatContactId);
    if (!contact) return;
    
    // 防止重复触发 - 检查是否已经有正在处理的请求
    if (window.aiReplyInProgress) {
        await showModal('AI正在回复中，请稍候...');
        return;
    }
    
    window.aiReplyInProgress = true;
    
    // UI feedback (Typing...)
    const typingMsg = { role: 'assistant', content: '<i class="fas fa-ellipsis-h"></i>', timestamp: Date.now(), isTyping: true };
    chat.messages.push(typingMsg);
    renderMessages();
    
    try {
        let reply = "";
        
        // 根据当前应用选择API配置
        let apiConfig;
        if (currentChatAppId === 'oo') {
            // OO软件使用副API
            apiConfig = appState.secondaryApiConfig;
        } else {
            // 其他应用使用主API
            apiConfig = appState.apiConfig;
        }
        
        if (apiConfig.key && apiConfig.url && apiConfig.model) {
            // Prepare Context - 增强版本，读取更多信息
            let systemPrompt = "你是一个角色扮演 AI。请根据用户的设定和当前的对话历史进行回复。请保持角色的语气和性格。不要跳出角色。\n\n";
            
            // Add World Settings - 读取所有世界观设定
            const worldSettings = appState.worldbook.filter(w => w.type === 'world');
            if (worldSettings.length > 0) {
                systemPrompt += "【世界观背景】\n";
                worldSettings.forEach(w => {
                    systemPrompt += `- ${w.title}: ${w.content}\n`;
                });
                systemPrompt += "\n";
            }
            
            // Add Character Settings - 角色人设 (独立的角色描述)
            if (contact.prompt) {
                systemPrompt += `【当前扮演角色设定】\n角色名称：${contact.name}\n人设描述：${contact.prompt}\n\n`;
            }
            
            // Add Character-specific Worldbook Settings - 关联的世界书设定 (用于规范和补充)
            if (contact.wbId) {
                const wbItem = appState.worldbook.find(w => w.id === contact.wbId);
                if (wbItem) {
                    systemPrompt += `【关联世界书设定】\n标题：${wbItem.title}\n内容：${wbItem.content}\n\n注意：此世界书设定用于规范角色行为和世界观，请结合上述角色人设一起使用。\n\n`;
                }
            }

            // Add User Persona - 用户当前人设
            let userCard;
            if (currentChatAppId === 'qq') userCard = appState.cardQQ;
            else if (currentChatAppId === 'oo') userCard = appState.cardOO;
            
            if (userCard && userCard.desc) {
                systemPrompt += `【用户(我)的设定】\n名字：${userCard.name}\n详细资料：${userCard.desc}\n\n请在回复中考虑用户的这些设定。`;
            }
            
            systemPrompt += "请严格按照以上设定进行角色扮演，保持角色的一致性和真实感。";

            // Construct Messages
            const messages = [
                { role: 'system', content: systemPrompt },
                ...chat.messages.filter(m => !m.isTyping).map(m => ({ role: m.role, content: m.content }))
            ];

            // Call API with timeout
            reply = await Promise.race([
                callLLM(messages),
                new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('请求超时，请检查网络连接')), 30000)
                )
            ]);
        } else {
            // Fallback Simulation
            await new Promise(r => setTimeout(r, 1000));
            if (contact && contact.prompt) {
                reply = `(模拟回复) ${contact.name}: 由于没有配置完整的 API 信息，我只能模拟回复。我的设定是: ${contact.prompt.substring(0, 50)}...`;
            } else {
                reply = `(模拟回复) ${contact.name}: 请先在设置中配置 API 地址、密钥和模型。`;
            }
        }
        
        // Remove typing indicator
        chat.messages = chat.messages.filter(m => !m.isTyping);
        
        chat.messages.push({
            role: 'assistant',
            content: reply,
            timestamp: Date.now()
        });
        
        saveState();
        if (currentChatContactId === contact.id) {
            renderMessages();
        }

    } catch (error) {
        console.error('LLM Error:', error);
        
        // Remove typing indicator
        chat.messages = chat.messages.filter(m => !m.isTyping);
        
        // 显示详细错误信息
        let errorMessage = `[连接失败]: `;
        if (error.message.includes('超时')) {
            errorMessage += '请求超时，请检查网络连接或稍后重试';
        } else if (error.message.includes('401')) {
            errorMessage += 'API密钥无效，请检查设置';
        } else if (error.message.includes('403')) {
            errorMessage += 'API访问被拒绝，请检查权限';
        } else if (error.message.includes('404')) {
            errorMessage += 'API地址不存在，请检查设置';
        } else if (error.message.includes('fetch')) {
            errorMessage += '网络连接失败，请检查网络或API地址';
        } else {
            errorMessage += error.message;
        }
        
        chat.messages.push({
            role: 'assistant',
            content: errorMessage,
            timestamp: Date.now()
        });
        
        saveState();
        renderMessages();
        
        // 显示错误提示
        await showModal('AI回复失败，请检查网络连接和API配置');
    } finally {
        // 重置状态标志
        window.aiReplyInProgress = false;
    }
};

async function callLLM(messages) {
    // 根据当前应用选择API配置
    let apiConfig;
    if (currentChatAppId === 'oo') {
        // OO软件使用副API
        apiConfig = appState.secondaryApiConfig;
    } else {
        // 其他应用使用主API
        apiConfig = appState.apiConfig;
    }

    const url = apiConfig.url;
    const key = apiConfig.key;
    const model = apiConfig.model || 'gpt-3.5-turbo';

    let endpoint = url;
    if (!endpoint.endsWith('/chat/completions')) {
        endpoint = endpoint.replace(/\/+$/, '') + '/chat/completions';
    }

    const headers = {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${key}`
    };

    const body = JSON.stringify({
        model: model,
        messages: messages,
        temperature: 0.7
    });

    const response = await fetch(endpoint, {
        method: 'POST',
        headers: headers,
        body: body
    });

    if (!response.ok) {
        const errText = await response.text();
        throw new Error(`API Error ${response.status}: ${errText}`);
    }

    const data = await response.json();
    if (data.choices && data.choices.length > 0 && data.choices[0].message) {
        return data.choices[0].message.content;
    } else {
        throw new Error('无效的 API 响应格式');
    }
}

// Handle contact avatar upload
const contactAvatarInput = document.getElementById('contactAvatarInput');
if (contactAvatarInput) {
    contactAvatarInput.onchange = (e) => handleImageUpload(e, (result) => {
        document.getElementById('contactAvatarPreview').src = result;
    });
}

// Override handleAppClick to support Chat App
const originalHandleAppClick = handleAppClick;
handleAppClick = function(app) {
    if (app.action === 'openChatApp') {
        openChatApp(app.id);
    } else if (app.id === 'qq' || app.id === 'oo') {
        openChatApp(app.id);
    } else {
        originalHandleAppClick(app);
    }
};

// Page Navigation
window.goToPage = function(pageIndex) {
    const pagesWrapper = document.getElementById('pagesWrapper');
    const pageWidth = pagesWrapper.clientWidth;
    pagesWrapper.scrollTo({
        left: pageIndex * pageWidth,
        behavior: 'smooth'
    });
    
    // Update indicators
    document.querySelectorAll('.page-dot').forEach((dot, index) => {
        if (index === pageIndex) {
            dot.classList.add('active');
        } else {
            dot.classList.remove('active');
        }
    });
};

// Update page indicators on scroll
function updatePageIndicators() {
    const pagesWrapper = document.getElementById('pagesWrapper');
    if (!pagesWrapper) return;
    
    pagesWrapper.addEventListener('scroll', () => {
        const pageWidth = pagesWrapper.clientWidth;
        const currentPage = Math.round(pagesWrapper.scrollLeft / pageWidth);
        
        document.querySelectorAll('.page-dot').forEach((dot, index) => {
            if (index === currentPage) {
                dot.classList.add('active');
            } else {
                dot.classList.remove('active');
            }
        });
    });
}

// Bottom Navigation Functions
window.switchToProfile = function() {
    // Update navigation buttons
    document.querySelectorAll('.bottom-nav-btn').forEach(btn => btn.classList.remove('active'));
    const profileBtn = document.querySelector('.bottom-nav-btn[onclick="switchToProfile()"]');
    if (profileBtn) profileBtn.classList.add('active');
    
    // Hide all chat app views
    const chatListView = document.getElementById('chatListView');
    const chatDetailView = document.getElementById('chatDetailView');
    const contactsView = document.getElementById('contactsView');
    const spaceView = document.getElementById('spaceView');
    const coupleSpaceView = document.getElementById('coupleSpaceView');
    const postEditorView = document.getElementById('postEditorView');
    const profileCardView = document.getElementById('profileCardView');
    const personaManagerView = document.getElementById('personaManagerView');
    
    if (chatListView) chatListView.style.display = 'none';
    if (chatDetailView) chatDetailView.style.display = 'none';
    if (contactsView) contactsView.style.display = 'none';
    if (spaceView) spaceView.style.display = 'none';
    if (coupleSpaceView) coupleSpaceView.style.display = 'none';
    if (postEditorView) postEditorView.style.display = 'none';
    if (personaManagerView) personaManagerView.style.display = 'none';
    
    // Show profile card view
    if (profileCardView) {
        profileCardView.style.display = 'flex';
        updateProfileCard();
    }
};

window.switchToMessages = function() {
    // Update navigation buttons
    document.querySelectorAll('.bottom-nav-btn').forEach(btn => btn.classList.remove('active'));
    const messagesBtn = document.querySelector('.bottom-nav-btn[onclick="switchToMessages()"]');
    if (messagesBtn) messagesBtn.classList.add('active');
    
    // Show chat list, hide other views
    const chatListView = document.getElementById('chatListView');
    const chatDetailView = document.getElementById('chatDetailView');
    const contactsView = document.getElementById('contactsView');
    const spaceView = document.getElementById('spaceView');
    const coupleSpaceView = document.getElementById('coupleSpaceView');
    const postEditorView = document.getElementById('postEditorView');
    const profileCardView = document.getElementById('profileCardView');
    const personaManagerView = document.getElementById('personaManagerView');
    
    if (chatListView) chatListView.style.display = 'flex';
    if (chatDetailView) chatDetailView.style.display = 'none';
    if (contactsView) contactsView.style.display = 'none';
    if (spaceView) spaceView.style.display = 'none';
    if (coupleSpaceView) coupleSpaceView.style.display = 'none';
    if (postEditorView) postEditorView.style.display = 'none';
    if (profileCardView) profileCardView.style.display = 'none';
    if (personaManagerView) personaManagerView.style.display = 'none';
    
    renderChatList();
};

window.switchToContacts = function() {
    // Update navigation buttons
    document.querySelectorAll('.bottom-nav-btn').forEach(btn => btn.classList.remove('active'));
    const contactsBtn = document.querySelector('.bottom-nav-btn[onclick="switchToContacts()"]');
    if (contactsBtn) contactsBtn.classList.add('active');
    
    // Show contacts view, hide others
    const chatListView = document.getElementById('chatListView');
    const chatDetailView = document.getElementById('chatDetailView');
    const contactsView = document.getElementById('contactsView');
    const spaceView = document.getElementById('spaceView');
    const coupleSpaceView = document.getElementById('coupleSpaceView');
    const postEditorView = document.getElementById('postEditorView');
    const profileCardView = document.getElementById('profileCardView');
    const personaManagerView = document.getElementById('personaManagerView');
    
    if (chatListView) chatListView.style.display = 'none';
    if (chatDetailView) chatDetailView.style.display = 'none';
    if (contactsView) contactsView.style.display = 'flex';
    if (spaceView) spaceView.style.display = 'none';
    if (coupleSpaceView) coupleSpaceView.style.display = 'none';
    if (postEditorView) postEditorView.style.display = 'none';
    if (profileCardView) profileCardView.style.display = 'none';
    if (personaManagerView) personaManagerView.style.display = 'none';
    
    renderContactsList();
};

window.renderContactsList = function() {
    const listEl = document.getElementById('contactsContent');
    listEl.innerHTML = '';
    
    const slot = (currentChatAppId === 'qq') ? appState.slotA : appState.slotB;
    
    if (!slot.contacts || slot.contacts.length === 0) {
        listEl.innerHTML = '<div class="settings-header-text" style="text-align: center; margin-top: 50px;">暂无联系人，点击右上角添加</div>';
        return;
    }
    
    slot.contacts.forEach(contact => {
        const div = document.createElement('div');
        div.className = 'settings-item';
        div.onclick = () => openContactProfile(contact.id);
        
        // 添加长按删除功能
        let longPressTimer;
        div.addEventListener('mousedown', (e) => {
            longPressTimer = setTimeout(() => {
                deleteContactFromList(contact.id);
            }, 800); // 800ms 长按
        });
        
        div.addEventListener('mouseup', () => {
            clearTimeout(longPressTimer);
        });
        
        div.addEventListener('mouseleave', () => {
            clearTimeout(longPressTimer);
        });
        
        // 触摸设备支持
        div.addEventListener('touchstart', (e) => {
            longPressTimer = setTimeout(() => {
                deleteContactFromList(contact.id);
            }, 800);
        });
        
        div.addEventListener('touchend', () => {
            clearTimeout(longPressTimer);
        });
        
        div.addEventListener('touchcancel', () => {
            clearTimeout(longPressTimer);
        });
        
        div.innerHTML = `
            <div class="avatar-wrapper" style="width: 40px; height: 40px; margin-right: 12px;">
                <img src="${contact.avatar}" style="border-radius: 50%; width: 100%; height: 100%; object-fit: cover;">
            </div>
            <div class="item-text" style="display: flex; flex-direction: column; align-items: flex-start;">
                <span style="font-weight: 500;">${contact.displayName || contact.name}</span>
                ${contact.remark ? `<span style="font-size: 12px; color: var(--sub-text-color);">${contact.remark}</span>` : ''}
            </div>
            <i class="fas fa-chevron-right arrow"></i>
        `;
        listEl.appendChild(div);
    });
};

window.openSpace = function() {
    // Update navigation buttons
    document.querySelectorAll('.space-nav-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelector('.space-nav-btn[onclick="openSpace()"]').classList.add('active');
    
    // Update space title based on current app
    const spaceTitle = document.getElementById('spaceTitle');
    spaceTitle.innerText = (currentChatAppId === 'qq') ? 'QQ空间' : 'OO空间';
    
    // Show space view, hide others
    document.getElementById('chatListView').style.display = 'none';
    document.getElementById('spaceView').style.display = 'flex';
    document.getElementById('coupleSpaceView').style.display = 'none';
    document.getElementById('postEditorView').style.display = 'none';
    
    renderSpacePosts();
};

window.openCoupleSpace = function() {
    // Update navigation buttons (only if they exist)
    const spaceNavBtns = document.querySelectorAll('.space-nav-btn');
    if (spaceNavBtns.length > 0) {
        spaceNavBtns.forEach(btn => btn.classList.remove('active'));
        const coupleSpaceBtn = document.querySelector('.space-nav-btn[onclick="openCoupleSpace()"]');
        if (coupleSpaceBtn) coupleSpaceBtn.classList.add('active');
    }
    
    // Show couple space view, hide others
    const chatListView = document.getElementById('chatListView');
    const spaceView = document.getElementById('spaceView');
    const coupleSpaceView = document.getElementById('coupleSpaceView');
    const postEditorView = document.getElementById('postEditorView');
    
    if (chatListView) chatListView.style.display = 'none';
    if (spaceView) spaceView.style.display = 'none';
    if (coupleSpaceView) coupleSpaceView.style.display = 'flex';
    if (postEditorView) postEditorView.style.display = 'none';
    
    renderCoupleSpacePosts();
};

window.switchToChat = function() {
    // Show chat list view and hide other views
    const chatListView = document.getElementById('chatListView');
    const contactsView = document.getElementById('contactsView');
    const spaceView = document.getElementById('spaceView');
    const coupleSpaceView = document.getElementById('coupleSpaceView');
    const postEditorView = document.getElementById('postEditorView');
    
    if (chatListView) chatListView.style.display = 'flex';
    if (contactsView) contactsView.style.display = 'none';
    if (spaceView) spaceView.style.display = 'none';
    if (coupleSpaceView) coupleSpaceView.style.display = 'none';
    if (postEditorView) postEditorView.style.display = 'none';
    
    // Update navigation buttons
    switchToMessages();
};

window.closeSpace = function() {
    switchToChat();
};

window.closeCoupleSpace = function() {
    switchToChat();
};

window.openPostEditor = function() {
    document.getElementById('spaceView').style.display = 'none';
    document.getElementById('postEditorView').style.display = 'flex';
    
    // Clear editor
    document.getElementById('postContentInput').value = '';
    document.getElementById('postImagePreview').style.display = 'none';
};

window.openCouplePostEditor = function() {
    document.getElementById('coupleSpaceView').style.display = 'none';
    document.getElementById('postEditorView').style.display = 'flex';
    
    // Clear editor
    document.getElementById('postContentInput').value = '';
    document.getElementById('postImagePreview').style.display = 'none';
};

window.closePostEditor = function() {
    document.getElementById('postEditorView').style.display = 'none';
    
    // Return to appropriate space view
    if (document.getElementById('coupleSpaceView').style.display === 'flex') {
        document.getElementById('coupleSpaceView').style.display = 'flex';
    } else {
        document.getElementById('spaceView').style.display = 'flex';
    }
};

window.savePost = function() {
    const content = document.getElementById('postContentInput').value.trim();
    const imageDisplay = document.getElementById('postImageDisplay');
    const image = imageDisplay ? imageDisplay.src : null;
    
    if (!content && !image) {
        showModal('请输入内容或添加图片');
        return;
    }
    
    const newPost = {
        id: Date.now().toString(),
        content: content,
        image: image && image !== 'https://via.placeholder.com/150' ? image : null,
        timestamp: Date.now(),
        author: appState.userName,
        avatar: appState.userAvatar,
        likes: 0,
        comments: []
    };
    
    // Determine which space to save to
    const isCouple = document.getElementById('coupleSpaceView').style.display === 'flex';
    
    if (isCouple) {
        if (!appState.couplePosts) appState.couplePosts = [];
        appState.couplePosts.unshift(newPost); // Add to beginning
    } else {
        const slot = (currentChatAppId === 'qq') ? appState.slotA : appState.slotB;
        if (!slot.posts) slot.posts = [];
        slot.posts.unshift(newPost); // Add to beginning
    }
    
    saveState();
    closePostEditor();
    
    // Refresh appropriate space
    if (isCouple) {
        openCoupleSpace();
    } else {
        openSpace();
    }
};

window.renderSpacePosts = function() {
    const container = document.getElementById('spaceContent');
    container.innerHTML = '';
    
    const slot = (currentChatAppId === 'qq') ? appState.slotA : appState.slotB;
    const posts = slot.posts || [];
    
    if (posts.length === 0) {
        container.innerHTML = '<div style="text-align: center; color: var(--sub-text-color); margin-top: 50px;">暂无动态，点击右上角发表第一条动态吧！</div>';
        return;
    }
    
    posts.forEach(post => {
        const postEl = createPostElement(post);
        container.appendChild(postEl);
    });
};

window.renderCoupleSpacePosts = function() {
    const container = document.getElementById('coupleSpaceContent');
    container.innerHTML = '';
    
    const posts = appState.couplePosts || [];
    
    if (posts.length === 0) {
        container.innerHTML = '<div style="text-align: center; color: var(--sub-text-color); margin-top: 50px;">暂无情侣动态，快来分享你们的甜蜜时光吧！</div>';
        return;
    }
    
    posts.forEach(post => {
        const postEl = createPostElement(post);
        container.appendChild(postEl);
    });
};

function createPostElement(post) {
    const div = document.createElement('div');
    div.className = 'space-post';
    
    const timeStr = new Date(post.timestamp).toLocaleString();
    
    div.innerHTML = `
        <div class="space-post-header">
            <img src="${post.avatar}" alt="Avatar" class="space-post-avatar">
            <div class="space-post-info">
                <div class="space-post-name">${post.author}</div>
                <div class="space-post-time">${timeStr}</div>
            </div>
        </div>
        ${post.content ? `<div class="space-post-content">${post.content}</div>` : ''}
        ${post.image ? `<img src="${post.image}" alt="Post Image" class="space-post-image">` : ''}
        <div class="space-post-actions">
            <div class="space-post-action" onclick="likePost('${post.id}')">
                <i class="fas fa-heart"></i>
                <span>${post.likes || 0}</span>
            </div>
            <div class="space-post-action">
                <i class="fas fa-comment"></i>
                <span>${post.comments ? post.comments.length : 0}</span>
            </div>
            <div class="space-post-action">
                <i class="fas fa-share"></i>
                <span>分享</span>
            </div>
        </div>
    `;
    
    return div;
}

window.likePost = function(postId) {
    // Find post in appropriate space
    let post = null;
    let isCouple = false;
    
    // Check couple space first
    if (appState.couplePosts) {
        post = appState.couplePosts.find(p => p.id === postId);
        if (post) isCouple = true;
    }
    
    // Check current app space
    if (!post) {
        const slot = (currentChatAppId === 'qq') ? appState.slotA : appState.slotB;
        if (slot.posts) {
            post = slot.posts.find(p => p.id === postId);
        }
    }
    
    if (post) {
        post.likes = (post.likes || 0) + 1;
        saveState();
        
        // Refresh appropriate view
        if (isCouple) {
            renderCoupleSpacePosts();
        } else {
            renderSpacePosts();
        }
    }
};

// Handle post image upload
const postImageInput = document.getElementById('postImageInput');
if (postImageInput) {
    postImageInput.onchange = (e) => handleImageUpload(e, (result) => {
        document.getElementById('postImageDisplay').src = result;
        document.getElementById('postImagePreview').style.display = 'block';
    });
}

// Start
window.applyCustomCss = function(silent = false) {
    const cssInput = document.getElementById('customCssInput');
    const css = cssInput ? cssInput.value : '';
    let styleTag = document.getElementById('custom-user-css');
    if (!styleTag) {
        styleTag = document.createElement('style');
        styleTag.id = 'custom-user-css';
        document.head.appendChild(styleTag);
    }
    styleTag.textContent = css;
    localStorage.setItem('customCss', css);
    
    if (!silent) {
        showModal('保存成功');
    }
};

window.resetCustomTheme = function() {
    showModal('确定要恢复默认主题吗？这将清空自定义 CSS 并恢复默认主题。', true).then(confirm => {
        if (confirm) {
            const cssInput = document.getElementById('customCssInput');
            if (cssInput) cssInput.value = '';
            
            const styleTag = document.getElementById('custom-user-css');
            if (styleTag) {
                styleTag.textContent = '';
                // Optional: remove element
                // styleTag.remove();
            }
            
            localStorage.removeItem('customCss');
            setTheme('default');
            showModal('已恢复默认主题');
        }
    });
};

window.renderThemePresets = function() {
    const select = document.getElementById('themePresetSelect');
    if (!select) return;
    select.innerHTML = '<option value="" disabled selected>选择预设...</option>';
    
    if (appState.themePresets && appState.themePresets.length > 0) {
        appState.themePresets.forEach((preset, index) => {
            const option = document.createElement('option');
            option.value = index;
            option.innerText = preset.name;
            select.appendChild(option);
        });
    }
};

window.saveThemePreset = function() {
    const nameInput = document.getElementById('themePresetNameInput');
    const name = nameInput ? nameInput.value.trim() : '';
    const cssInput = document.getElementById('customCssInput');
    const css = cssInput ? cssInput.value : '';

    if (!name) {
        showModal('请输入预设名称');
        return;
    }
    if (!css) {
        showModal('CSS 内容为空');
        return;
    }

    if (!appState.themePresets) {
        appState.themePresets = [];
    }

    appState.themePresets.push({ name: name, css: css });
    saveState();
    renderThemePresets();
    if (nameInput) nameInput.value = '';
    showModal('主题预设保存成功');
};

window.loadThemePreset = function(e) {
    const index = e.target.value;
    if (appState.themePresets && appState.themePresets[index]) {
        const preset = appState.themePresets[index];
        const cssInput = document.getElementById('customCssInput');
        if (cssInput) {
            cssInput.value = preset.css;
            // Apply immediately
            applyCustomCss(true); // silent apply
            showModal(`已加载主题: ${preset.name}`);
        }
        e.target.value = ""; // Reset select
    }
};

// Profile Card Functions
window.updateProfileCard = function() {
    const profileCardBg = document.getElementById('profileCardBg');
    const profileCardAvatarImg = document.getElementById('profileCardAvatarImg');
    const profileCardName = document.getElementById('profileCardName');
    const profileCardSign = document.getElementById('profileCardSign');
    const profileCardId = document.getElementById('profileCardId');
    
    // Determine which card data to use based on current app
    let cardData;
    if (currentChatAppId === 'qq') {
        if (!appState.cardQQ) appState.cardQQ = JSON.parse(JSON.stringify(appState.card || {}));
        cardData = appState.cardQQ;
    } else if (currentChatAppId === 'oo') {
        if (!appState.cardOO) appState.cardOO = JSON.parse(JSON.stringify(appState.card || {}));
        cardData = appState.cardOO;
    } else {
        cardData = appState.card;
    }

    // Update background
    if (cardData && cardData.bg) {
        profileCardBg.style.backgroundImage = `url('${cardData.bg}')`;
    } else {
        profileCardBg.style.backgroundImage = 'none';
        profileCardBg.style.backgroundColor = '#ccc';
    }
    
    // Update avatar
    if (cardData && cardData.avatar) {
        profileCardAvatarImg.src = cardData.avatar;
    } else {
        profileCardAvatarImg.src = 'https://via.placeholder.com/150';
    }
    
    // Update name
    if (profileCardName) {
        profileCardName.innerText = cardData?.name || appState.userName || '用户名';
    }
    
    // Update signature
    if (profileCardSign) {
        profileCardSign.innerText = cardData?.sign || '个性签名';
    }
    
    // Update ID
    if (profileCardId) {
        const appName = currentChatAppId === 'qq' ? 'QQ' : 'OO';
        const idVal = cardData?.id || '123456789';
        profileCardId.innerText = `${appName}号: ${idVal}`;
    }

    // Update Visitors
    const visitorCount = document.getElementById('visitorCount');
    if (visitorCount) {
        visitorCount.innerText = cardData?.visitors || '0';
    }

    // Update Tags
    const tagsContainer = document.getElementById('profileTagsContainer');
    if (tagsContainer) {
        tagsContainer.innerHTML = '';
        const tags = cardData?.tags || ['添加标签'];
        tags.forEach((tag, index) => {
            const tagEl = document.createElement('div');
            tagEl.innerText = tag;
            tagEl.style.cssText = 'border-radius: 12px; background: rgba(0,0,0,0.05); padding: 2px 8px; font-size: 10px; color: var(--text-color); cursor: pointer;';
            tagEl.onclick = () => editProfileTag(index);
            tagsContainer.appendChild(tagEl);
        });
        
        // Add Button
        const addBtn = document.createElement('div');
        addBtn.innerHTML = '<i class="fas fa-plus"></i>';
        addBtn.style.cssText = 'border-radius: 12px; background: rgba(0,0,0,0.05); padding: 2px 8px; font-size: 10px; color: var(--text-color); cursor: pointer; display: flex; align-items: center;';
        addBtn.onclick = () => addProfileTag();
        tagsContainer.appendChild(addBtn);
    }

    // Update Recent Post
    const recentPostContainer = document.getElementById('profileRecentPost');
    const recentPostText = document.getElementById('profileRecentPostText');
    const recentPostImg = document.getElementById('profileRecentPostImg');

    if (recentPostContainer && recentPostText && recentPostImg) {
        const slot = (currentChatAppId === 'qq') ? appState.slotA : appState.slotB;
        const posts = slot.posts || [];
        
        if (posts.length > 0) {
            const latest = posts[0];
            recentPostText.innerText = latest.content || '[图片]';
            if (latest.image) {
                recentPostImg.src = latest.image;
                recentPostImg.style.display = 'block';
            } else {
                recentPostImg.style.display = 'none';
            }
        } else {
            recentPostText.innerText = '分享你的第一条动态...';
            recentPostImg.style.display = 'none';
        }
    }

    // Update Polaroids - 使用独立的拍立得图片
    const polaroids = cardData?.polaroids || appState.profilePolaroids;
    if (polaroids) {
        polaroids.forEach((url, index) => {
            const img = document.getElementById(`profilePolaroid${index + 1}Img`);
            if (img) img.src = url;
        });
    }
};

window.closeProfileCard = function() {
    const profileCardView = document.getElementById('profileCardView');
    if (profileCardView) {
        profileCardView.style.display = 'none';
    }
    
    // Return to chat list
    switchToMessages();
};

window.editProfileCardName = async function() {
    let cardData;
    if (currentChatAppId === 'qq') cardData = appState.cardQQ;
    else if (currentChatAppId === 'oo') cardData = appState.cardOO;
    else cardData = appState.card;

    const currentName = cardData?.name || '用户名';
    const newName = await showInputModal('请输入用户名:', currentName);
    if (newName !== null) {
        if (!cardData) cardData = {};
        cardData.name = newName;
        
        // Save back to state
        if (currentChatAppId === 'qq') appState.cardQQ = cardData;
        else if (currentChatAppId === 'oo') appState.cardOO = cardData;
        else appState.card = cardData;

        updateProfileCard();
        saveState();
    }
};

window.editProfileCardSign = async function() {
    let cardData;
    if (currentChatAppId === 'qq') cardData = appState.cardQQ;
    else if (currentChatAppId === 'oo') cardData = appState.cardOO;
    else cardData = appState.card;

    const currentSign = cardData?.sign || '个性签名';
    const newSign = await showInputModal('请输入个性签名:', currentSign);
    if (newSign !== null) {
        if (!cardData) cardData = {};
        cardData.sign = newSign;

        // Save back to state
        if (currentChatAppId === 'qq') appState.cardQQ = cardData;
        else if (currentChatAppId === 'oo') appState.cardOO = cardData;
        else appState.card = cardData;

        updateProfileCard();
        saveState();
    }
};

window.editProfileCardId = async function() {
    const appName = currentChatAppId === 'qq' ? 'QQ' : 'OO';
    
    let cardData;
    if (currentChatAppId === 'qq') cardData = appState.cardQQ;
    else if (currentChatAppId === 'oo') cardData = appState.cardOO;
    else cardData = appState.card;

    const currentId = cardData?.id || '';
    const newId = await showInputModal(`请输入${appName}号:`, currentId);
    if (newId !== null && newId.trim()) {
        if (!cardData) cardData = {};
        cardData.id = newId.trim();

        // Save back to state
        if (currentChatAppId === 'qq') appState.cardQQ = cardData;
        else if (currentChatAppId === 'oo') appState.cardOO = cardData;
        else appState.card = cardData;

        updateProfileCard();
        saveState();
    }
};

window.editProfileCardVisitors = async function() {
    let cardData;
    if (currentChatAppId === 'qq') cardData = appState.cardQQ;
    else if (currentChatAppId === 'oo') cardData = appState.cardOO;
    else cardData = appState.card;

    const currentVal = cardData?.visitors || '0';
    const newVal = await showInputModal('请输入今日访客量:', currentVal);
    if (newVal !== null) {
        if (!cardData) cardData = {};
        cardData.visitors = newVal;
        
        // Save back to state
        if (currentChatAppId === 'qq') appState.cardQQ = cardData;
        else if (currentChatAppId === 'oo') appState.cardOO = cardData;
        else appState.card = cardData;

        updateProfileCard();
        saveState();
    }
};

window.editProfileTag = async function(index) {
    let cardData;
    if (currentChatAppId === 'qq') cardData = appState.cardQQ;
    else if (currentChatAppId === 'oo') cardData = appState.cardOO;
    else cardData = appState.card;

    if (!cardData.tags) cardData.tags = ['添加标签'];
    
    const currentTag = cardData.tags[index];
    
    // Custom dialog to edit or delete
    const result = await showInputModal('编辑标签 (输入空值删除):', currentTag);
    
    if (result !== null) {
        if (result.trim() === '') {
            // Delete
            cardData.tags.splice(index, 1);
        } else {
            // Update
            cardData.tags[index] = result.trim();
        }
        
        // Save back to state
        if (currentChatAppId === 'qq') appState.cardQQ = cardData;
        else if (currentChatAppId === 'oo') appState.cardOO = cardData;
        else appState.card = cardData;

        updateProfileCard();
        saveState();
    }
};

window.addProfileTag = async function() {
    let cardData;
    if (currentChatAppId === 'qq') cardData = appState.cardQQ;
    else if (currentChatAppId === 'oo') cardData = appState.cardOO;
    else cardData = appState.card;

    const newTag = await showInputModal('新标签内容:', '');
    
    if (newTag !== null && newTag.trim() !== '') {
        if (!cardData.tags) cardData.tags = [];
        cardData.tags.push(newTag.trim());
        
        // Save back to state
        if (currentChatAppId === 'qq') appState.cardQQ = cardData;
        else if (currentChatAppId === 'oo') appState.cardOO = cardData;
        else appState.card = cardData;

        updateProfileCard();
        saveState();
    }
};

// Persona Manager Functions
window.openPersonaManager = function() {
    // Get current data
    let cardData;
    if (currentChatAppId === 'qq') cardData = appState.cardQQ;
    else if (currentChatAppId === 'oo') cardData = appState.cardOO;
    else cardData = appState.card;

    // Fill inputs
    document.getElementById('personaManagerAvatar').src = cardData?.avatar || 'https://via.placeholder.com/150';
    document.getElementById('personaManagerName').value = cardData?.name || '';
    document.getElementById('personaManagerSign').value = cardData?.sign || '';
    document.getElementById('personaManagerDesc').value = cardData?.desc || ''; // Fill desc

    // Show view
    document.getElementById('profileCardView').style.display = 'none';
    document.getElementById('personaManagerView').style.display = 'flex';
    
    renderPersonaPresets();
};

window.closePersonaManager = function() {
    document.getElementById('personaManagerView').style.display = 'none';
    document.getElementById('profileCardView').style.display = 'flex';
    updateProfileCard();
};

window.updateCurrentPersona = function(field, value) {
    let cardData;
    if (currentChatAppId === 'qq') cardData = appState.cardQQ;
    else if (currentChatAppId === 'oo') cardData = appState.cardOO;
    else cardData = appState.card; // Fallback

    if (!cardData) return;

    if (field === 'name') cardData.name = value;
    if (field === 'sign') cardData.sign = value;
    if (field === 'desc') cardData.desc = value;

    // Save
    if (currentChatAppId === 'qq') appState.cardQQ = cardData;
    else if (currentChatAppId === 'oo') appState.cardOO = cardData;
    
    saveState();
    // No need to updateProfileCard() yet as we are in manager view
};

window.saveCurrentAsPersonaPreset = async function() {
    const avatar = document.getElementById('personaManagerAvatar').src;
    const name = document.getElementById('personaManagerName').value;
    const sign = document.getElementById('personaManagerSign').value;
    const desc = document.getElementById('personaManagerDesc').value;

    if (!name) {
        showModal('请输入名字');
        return;
    }

    if (!appState.personas) appState.personas = [];
    
    const newPersona = {
        id: Date.now().toString(),
        name: name,
        sign: sign,
        desc: desc,
        avatar: avatar
    };
    
    appState.personas.push(newPersona);
    saveState();
    // 立即更新预设库显示
    renderPersonaPresets();
    showModal('已保存到预设库');
};

window.renderPersonaPresets = function() {
    const list = document.getElementById('personaPresetsList');
    if (!list) return;
    list.innerHTML = '';
    
    if (!appState.personas || appState.personas.length === 0) {
        list.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--sub-text-color); font-size: 12px;">暂无预设</div>';
        return;
    }
    
    appState.personas.forEach((persona, index) => {
        const item = document.createElement('div');
        item.className = 'settings-item';
        // Add swipe logic or long press? For simplicity, click to apply, long press or button to delete?
        // Let's add a delete button
        item.innerHTML = `
            <div class="avatar-wrapper" style="width: 40px; height: 40px; margin-right: 12px;">
                <img src="${persona.avatar}" style="border-radius: 50%; width: 100%; height: 100%; object-fit: cover;">
            </div>
            <div class="item-text" style="display: flex; flex-direction: column; align-items: flex-start; flex: 1;">
                <span style="font-weight: 500;">${persona.name}</span>
                <span style="font-size: 12px; color: var(--sub-text-color);">${persona.sign || '无签名'}</span>
            </div>
            <button onclick="deletePersonaPreset(${index}, event)" style="border: none; background: none; color: var(--red); padding: 5px;">
                <i class="fas fa-trash"></i>
            </button>
        `;
        item.onclick = () => applyPersonaPreset(index);
        list.appendChild(item);
    });
};

window.applyPersonaPreset = function(index) {
    if (!appState.personas || !appState.personas[index]) return;
    
    const persona = appState.personas[index];
    
    let cardData;
    if (currentChatAppId === 'qq') {
        if (!appState.cardQQ) appState.cardQQ = {};
        cardData = appState.cardQQ;
    } else if (currentChatAppId === 'oo') {
        if (!appState.cardOO) appState.cardOO = {};
        cardData = appState.cardOO;
    } else {
        cardData = appState.card;
    }
    
    // Apply values
    cardData.name = persona.name;
    cardData.sign = persona.sign;
    cardData.avatar = persona.avatar;
    cardData.desc = persona.desc;
    
    saveState();
    
    // Update inputs in manager view
    document.getElementById('personaManagerAvatar').src = persona.avatar;
    document.getElementById('personaManagerName').value = persona.name;
    document.getElementById('personaManagerSign').value = persona.sign;
    document.getElementById('personaManagerDesc').value = persona.desc || '';
    
    showModal(`已应用人设: ${persona.name}`);
};

window.deletePersonaPreset = function(index, event) {
    if (event) event.stopPropagation();
    
    showModal('确定删除此预设吗？', true).then(confirm => {
        if (confirm) {
            appState.personas.splice(index, 1);
            saveState();
            // 立即更新预设库显示
            renderPersonaPresets();
            showModal('预设已删除');
        }
    });
};

window.openContactProfile = function(contactId) {
    const slot = (currentChatAppId === 'qq') ? appState.slotA : appState.slotB;
    const contact = slot.contacts.find(c => c.id === contactId);
    
    if (!contact) return;
    
    // 填充联系人编辑表单
    document.getElementById('contactNameInput').value = contact.name;
    document.getElementById('contactAvatarPreview').src = contact.avatar;
    document.getElementById('contactPromptInput').value = contact.prompt || '';
    
    // 设置世界书选择
    const select = document.getElementById('contactWorldbookSelect');
    select.innerHTML = '<option value="">无关联</option>';
    if (appState.worldbook && appState.worldbook.length > 0) {
        appState.worldbook.forEach(item => {
            if (item.type === 'character' || item.type === 'world') {
                const option = document.createElement('option');
                option.value = item.id;
                option.innerText = item.title;
                if (contact.wbId === item.id) {
                    option.selected = true;
                }
                select.appendChild(option);
            }
        });
    }
    
    // 存储当前编辑的联系人ID
    window.currentEditingContactId = contactId;
    
    // 显示编辑界面
    document.getElementById('contactsView').style.display = 'none';
    document.getElementById('addContactView').style.display = 'flex';
    
    // 显示删除按钮（仅在编辑现有联系人时）
    const deleteGroup = document.getElementById('contactDeleteGroup');
    if (deleteGroup) {
        deleteGroup.style.display = 'block';
    }
    
    // 修改完成按钮文本和功能
    const completeBtn = document.querySelector('#addContactView .header-btn[onclick="saveContact()"]');
    if (completeBtn) {
        completeBtn.innerText = '保存';
        completeBtn.onclick = () => updateContact();
    }
};

window.updateContact = function() {
    if (!window.currentEditingContactId) return;
    
    const slot = (currentChatAppId === 'qq') ? appState.slotA : appState.slotB;
    const contact = slot.contacts.find(c => c.id === window.currentEditingContactId);
    
    if (!contact) return;
    
    const name = document.getElementById('contactNameInput').value.trim();
    const displayName = document.getElementById('contactDisplayNameInput').value.trim();
    const remark = document.getElementById('contactRemarkInput').value.trim();
    const avatar = document.getElementById('contactAvatarPreview').src;
    const wbId = document.getElementById('contactWorldbookSelect').value;
    const prompt = document.getElementById('contactPromptInput').value;
    
    if (!name) {
        showModal('请输入昵称');
        return;
    }
    
    // 更新联系人信息
    contact.name = name;
    contact.displayName = displayName || null;
    contact.remark = remark || null;
    contact.avatar = avatar;
    contact.wbId = wbId;
    contact.prompt = prompt;
    
    saveState();
    
    // 重置编辑状态
    window.currentEditingContactId = null;
    
    // 恢复完成按钮
    const completeBtn = document.querySelector('#addContactView .header-btn[onclick="updateContact()"]');
    if (completeBtn) {
        completeBtn.innerText = '完成';
        completeBtn.onclick = () => saveContact();
    }
    
    closeAddContact();
    renderContactsList();
    showModal('联系人信息已更新');
};

// 删除联系人函数 - 从联系人列表长按删除
window.deleteContactFromList = async function(contactId) {
    const slot = (currentChatAppId === 'qq') ? appState.slotA : appState.slotB;
    const contact = slot.contacts.find(c => c.id === contactId);
    
    if (!contact) return;
    
    const confirm = await showModal(`确定要删除联系人 "${contact.name}" 吗？`, true);
    if (confirm) {
        // 删除联系人
        slot.contacts = slot.contacts.filter(c => c.id !== contactId);
        
        // 删除相关的聊天记录
        if (slot.chats) {
            slot.chats = slot.chats.filter(c => c.contactId !== contactId);
        }
        
        saveState();
        renderContactsList();
        showModal('删除成功');
    }
};

// 从联系人详情页删除联系人
window.deleteContactFromProfile = async function() {
    if (!window.currentEditingContactId) return;
    
    const slot = (currentChatAppId === 'qq') ? appState.slotA : appState.slotB;
    const contact = slot.contacts.find(c => c.id === window.currentEditingContactId);
    
    if (!contact) return;
    
    const confirm = await showModal(`确定要删除联系人 "${contact.name}" 吗？`, true);
    if (confirm) {
        // 删除联系人
        slot.contacts = slot.contacts.filter(c => c.id !== window.currentEditingContactId);
        
        // 删除相关的聊天记录
        if (slot.chats) {
            slot.chats = slot.chats.filter(c => c.contactId !== window.currentEditingContactId);
        }
        
        // 重置编辑状态
        window.currentEditingContactId = null;
        
        // 恢复完成按钮
        const completeBtn = document.querySelector('#addContactView .header-btn[onclick="updateContact()"]');
        if (completeBtn) {
            completeBtn.innerText = '完成';
            completeBtn.onclick = () => saveContact();
        }
        
        saveState();
        closeAddContact();
        renderContactsList();
        showModal('删除成功');
    }
};

// 朋友档案管理功能
window.openFriendsManager = function() {
    // 这里可以添加朋友档案管理界面
    // 由于界面复杂度，暂时用简单的输入框实现
    showTextareaModal('管理朋友档案 (输入朋友信息，每行一个朋友):', '').then(result => {
        if (result !== null) {
            // 处理朋友档案数据
            const friends = result.split('\n').filter(line => line.trim()).map(line => ({
                name: line.trim(),
                relationship: '朋友',
                description: ''
            }));
            
            // 如果是编辑现有联系人
            if (window.currentEditingContactId) {
                const slot = (currentChatAppId === 'qq') ? appState.slotA : appState.slotB;
                const contact = slot.contacts.find(c => c.id === window.currentEditingContactId);
                if (contact) {
                    contact.friends = friends;
                    saveState();
                    showModal('朋友档案已更新');
                }
            } else {
                // 新建联系人时暂存朋友档案
                window.tempFriends = friends;
                showModal('朋友档案已设置，请完成联系人创建');
            }
        }
    });
};

window.editProfile = function() {
    openPersonaManager();
};

const personaAvatarInput = document.getElementById('personaAvatarInput');
if (personaAvatarInput) {
    personaAvatarInput.onchange = (e) => handleImageUpload(e, (result) => {
        document.getElementById('personaManagerAvatar').src = result;
        
        // Also update current state immediately
        let cardData;
        if (currentChatAppId === 'qq') cardData = appState.cardQQ;
        else if (currentChatAppId === 'oo') cardData = appState.cardOO;
        
        if (cardData) {
            cardData.avatar = result;
            saveState();
        }
    });
}

// Handle profile card image uploads
const profileCardBgInput = document.getElementById('profileCardBgInput');
if (profileCardBgInput) {
    profileCardBgInput.onchange = (e) => handleImageUpload(e, (result) => {
        let cardData;
        if (currentChatAppId === 'qq') {
            if (!appState.cardQQ) appState.cardQQ = {};
            cardData = appState.cardQQ;
        } else if (currentChatAppId === 'oo') {
            if (!appState.cardOO) appState.cardOO = {};
            cardData = appState.cardOO;
        } else {
            if (!appState.card) appState.card = {};
            cardData = appState.card;
        }

        cardData.bg = result;
        updateProfileCard();
        saveState();
    });
}

const profileCardAvatarInput = document.getElementById('profileCardAvatarInput');
if (profileCardAvatarInput) {
    profileCardAvatarInput.onchange = (e) => handleImageUpload(e, (result) => {
        let cardData;
        if (currentChatAppId === 'qq') {
            if (!appState.cardQQ) appState.cardQQ = {};
            cardData = appState.cardQQ;
        } else if (currentChatAppId === 'oo') {
            if (!appState.cardOO) appState.cardOO = {};
            cardData = appState.cardOO;
        } else {
            if (!appState.card) appState.card = {};
            cardData = appState.card;
        }

        cardData.avatar = result;
        updateProfileCard();
        saveState();
    });
}

// Handle polaroid uploads - 保存到对应的卡片数据中
[1, 2, 3, 4].forEach(index => {
    const input = document.getElementById(`profilePolaroid${index}Input`);
    if (input) {
        input.onchange = (e) => handleImageUpload(e, (result) => {
            let cardData;
            if (currentChatAppId === 'qq') {
                if (!appState.cardQQ) appState.cardQQ = {};
                cardData = appState.cardQQ;
            } else if (currentChatAppId === 'oo') {
                if (!appState.cardOO) appState.cardOO = {};
                cardData = appState.cardOO;
            } else {
                // 后备方案，保存到全局
                if (!appState.profilePolaroids) appState.profilePolaroids = [];
                appState.profilePolaroids[index - 1] = result;
                updateProfileCard();
                saveState();
                return;
            }
            
            if (!cardData.polaroids) cardData.polaroids = [];
            cardData.polaroids[index - 1] = result;
            updateProfileCard();
            saveState();
        });
    }
});

window.addEventListener('DOMContentLoaded', () => {
    init();
    updatePageIndicators();
});
